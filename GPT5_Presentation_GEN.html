<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S1 — Hub vs Switch - Présentation interactive (v3.5.0)</title>
<meta name="color-scheme" content="dark light"/>
<style>
/* ============ THEME & TOKENS ============ */
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#9aa4b2;
  --accent:#60a5fa; --accent-2:#f59e0b; --ok:#10b981; --danger:#ef4444;
  --ring:0 0 0 3px #60a5fa33; --shadow:0 10px 30px rgba(0,0,0,.35);
  --ui:#111827; --border:#223046;
  --img-opacity:.12; --img-blur:2px;
  --font-size:20px; --radius:20px; --transition:.25s ease;
  /* toolbar + timeline */
  --toolbar-bg: #111827ee;
  --timeline-bg:#132033; --timeline-active:#2563eb; --timeline-done:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 520px at 5% -20%, #1d4ed81a, transparent 60%),
    radial-gradient(900px 420px at 110% 120%, #f59e0b1a, transparent 60%),
    var(--bg);
  color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  -webkit-font-smoothing: antialiased; line-height:1.55; font-size: var(--font-size);
  transition: background var(--transition), color var(--transition);
}
@media (prefers-reduced-motion: reduce){ *{animation:none!important; transition:none!important} }

/* ============ LAYOUT ============ */
#app{height:100%; display:flex; flex-direction:column;}
.deck-wrap{flex:1; display:flex; align-items:center; justify-content:center; padding:24px 24px 110px;}
.deck{
  width:1280px; height:720px; position:relative; background:var(--panel);
  border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); transform-origin: top left;
  display:grid; grid-template-rows: 64px 1fr 56px; border:1px solid var(--border);
}

/* Header */
.bar-top{ display:flex; align-items:center; justify-content:space-between; padding:0 18px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0f172a,#0b1526); }
.brand{display:flex; align-items:center; gap:10px}
.logo{display:flex; gap:6px; align-items:center; font-weight:800; font-size:18px;}
.logo .icon{font-size:24px;}
.brand .sub{font-size:12px; color:var(--muted); margin-left:6px; font-weight:600}
.meta{display:flex; align-items:center; gap:10px}
.meta .badge{font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px; background:var(--ui); border:1px solid var(--border)}
.controls{display:flex; align-items:center; gap:8px}
.btn{background:var(--ui); border:1px solid var(--border); color:var(--ink); border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; transition: all var(--transition);} 
.btn:hover{box-shadow:var(--ring); transform:translateY(-1px);} 
.btn:active{transform:translateY(0)}
.btn[aria-pressed="true"]{outline:3px solid #60a5fa66}
.input{ background:var(--ui); border:1px solid var(--border); color:var(--ink); border-radius:10px; padding:6px 10px; font-weight:700; font-size:12px; min-width:180px; }

/* Content */
.content{position:relative; overflow:hidden;}
.bg-illus{ position:absolute; inset:0; pointer-events:none; z-index:0; background-position:center; background-size:cover; background-repeat:no-repeat; opacity: var(--img-opacity); filter: blur(var(--img-blur)); transition: opacity var(--transition), filter var(--transition); }
.slide-viewport{position:absolute; inset:0; padding:28px 56px; overflow:auto; z-index:1; touch-action: pan-y;}
.slide{display:none; min-height:100%} 
.slide.active{display:block; animation: slideIn .35s cubic-bezier(0.4, 0, 0.2, 1)}
@keyframes slideIn{from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:none}}

h1{font-size:44px; line-height:1.08; margin:0 0 6px 0}
h2{font-size:32px; line-height:1.14; margin:8px 0 8px}
h3{font-size:24px; margin:12px 0 8px}
p{margin:8px 0}
ul,ol{padding-left:26px; margin:10px 0}
li{margin:8px 0}
small{color:var(--muted)} strong{color:#fff}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#0006; padding:.1em .35em; border-radius:6px; border:1px solid var(--border)}

/* Blocks */
.title-block{ background: linear-gradient(180deg,#1e293bcc,#111827cc); border:1px solid var(--border); color:#fff; padding:18px 22px; border-left:8px solid var(--accent); border-radius:12px; box-shadow:var(--shadow); }
.callout{display:flex; gap:12px; align-items:flex-start; background:#111827; border-left:6px solid var(--accent); padding:12px 14px; border-radius:10px; border:1px solid var(--border)}
figure{margin:14px 0; text-align:center}
figure img{max-width:100%; max-height:420px; border-radius:12px; border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.35)}
figure figcaption{font-size:12px; color:var(--muted); margin-top:6px}

/* Tables */
table{width:100%; border-collapse: collapse; margin:10px 0 6px}
th,td{border:1px solid var(--border); padding:8px 10px; text-align:left}
thead th{background:#0b1526}

/* Footer */
.footer{display:flex; align-items:center; justify-content:space-between; padding:0 18px; border-top:1px solid var(--border); background:#0b1526; color:var(--muted); font-size:13px}
.counter{font-weight:800; color:var(--accent)}
.progressbar{height:6px; width:100%; background:#132033; border-top:1px solid var(--border)}
.progress{height:100%; width:0; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transform-origin:left; transition: width var(--transition);}

/* Timeline segments */
.timeline{position:absolute; left:18px; right:18px; bottom:62px; height:12px; display:grid; gap:4px; grid-auto-flow:column; background:transparent; pointer-events:auto}
.timeline .seg{background:var(--timeline-bg); border:1px solid var(--border); border-radius:999px; height:100%; cursor:pointer; transition:transform .15s}
.timeline .seg:hover{transform:translateY(-1px); box-shadow:var(--ring)}
.timeline .seg.done{background:var(--timeline-done)}
.timeline .seg.active{background:var(--timeline-active)}

/* Grid */
.grid{position:absolute; inset:0; background:#000e; display:none; padding:22px; z-index:10; backdrop-filter:blur(12px);} .grid.active{display:block; animation: fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0} to{opacity:1}}
.grid-inner{display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:14px; align-items:start; overflow-y:auto; max-height:100%;}
.thumb{background:#0b1526; border:1px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer; transition: all var(--transition);} .thumb:hover{box-shadow:var(--ring); transform:scale(1.03);} .thumb .num{font-weight:800; padding:8px 10px; color:var(--muted); font-size:12px} .thumb .mini{width:100%; aspect-ratio:16/9; background:#0f172a; position:relative; overflow:hidden} .thumb .mini-inner{position:absolute; inset:0; transform:scale(.22); transform-origin: top left; padding:18px 26px; pointer-events:none;}

/* Toolbar */
.toolbar{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; display:flex; gap:8px; z-index:50; background:var(--toolbar-bg); padding:6px; border-radius:999px; border:1px solid var(--border); backdrop-filter:blur(12px); box-shadow:var(--shadow); }
.tbtn{background:#0f172a; border:1px solid var(--border); color:var(--ink); border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer; transition: all var(--transition);} .tbtn:hover{box-shadow:var(--ring); transform:scale(1.05);} .tbtn:active{transform:none}

/* Fragments */
.fragment{opacity:0; transform: translateY(10px); transition: all .35s cubic-bezier(0.4, 0, 0.2, 1)}
.fragment.visible{opacity:1; transform:none}

/* Checklists */
.check{display:flex; align-items:flex-start; gap:10px}
.check input{width:20px; height:20px; margin-top:2px}
.check label{cursor:pointer}

/* Quiz */
.quiz{border:1px solid var(--border); background:#0b1526; border-radius:12px; padding:16px; margin:16px 0}
.q-title{font-weight:800; margin-bottom:12px; font-size:18px;}
.q-options{display:block; margin:8px 0}
.q-option{border:1px solid var(--border); padding:12px 16px; border-radius:10px; cursor:pointer; margin:8px 0; background:#0f172a; transition: all var(--transition); outline:0;}
.q-option:hover{box-shadow:var(--ring); transform:translateX(4px);} .q-option.selected{border-color:var(--accent); background:#60a5fa1a;}
.q-option.correct.show{background:#10b98122; border-color:#10b981;} .q-option.wrong.show{background:#ef444422; border-color:#ef4444;}
.q-actions{display:flex; gap:8px; margin-top:12px}
.q-actions .btn{padding:8px 12px; font-size:14px;}

/* Settings Panel */
.panel{ position:fixed; right:18px; top:88px; width:380px; max-width:calc(100vw - 36px); background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; display:none; z-index:60; }
.panel.active{display:block; animation: slideDown .25s ease}
@keyframes slideDown{from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:none}}
.panel h4{margin:0 0 12px 0}
.panel .row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0}
.panel input[type="range"]{width:140px}
.panel .input{width:200px}
.switch{display:flex; align-items:center; gap:8px}
.switch input{width:20px; height:20px}

/* All-in-one & Print */
.all-view{display:none}
.allinone .deck{display:none}
.allinone .all-view{display:block; padding:24px; max-width:1280px; margin:0 auto}
.allinone .all-view .slide{display:block; position:relative; padding:28px 56px; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:18px}
#printRoot{display:none}
.page-num{position:absolute; right:20px; bottom:14px; font-size:12px; color:var(--muted)}

@media print{
  body{background:#fff; color:#000}
  .toolbar,.panel,.grid,.bg-illus,.draw-overlay,.timer,.help,.timeline,.step-indicator{display:none !important}
  #app{display:block}
  #printRoot{display:block; padding:0; margin:0}
  #printRoot .slide{display:block; page-break-inside:avoid; background:#fff; color:#000; border:none; padding:20mm; height:auto}
  #printRoot h1,#printRoot h2,#printRoot h3,#printRoot p,#printRoot li,#printRoot table{color:#000}
}

/* LIGHT THEME */
body.theme-light{
  --bg:#f7fafc; --panel:#ffffff; --ink:#0b1220; --muted:#5b6b7f; --accent:#2563eb; --accent-2:#ea580c; --ring: 0 0 0 3px #2563eb33; --border:#e2e8f0; --ui:#f1f5f9; --img-opacity:.06; --img-blur:1px;
  --toolbar-bg:#ffffffee;
  --timeline-bg:#e5edf8; --timeline-active:#2563eb; --timeline-done:#ea580c;
  background:
    radial-gradient(1200px 520px at 5% -20%, #2563eb0a, transparent 60%),
    radial-gradient(900px 420px at 110% 120%, #ea580c0a, transparent 60%),
    var(--bg);
}
body.theme-light .bar-top{background: linear-gradient(180deg,#ffffff,#f7fafc);} 
body.theme-light .footer{background:#ffffff; color: var(--muted); border-top:1px solid var(--border);} 
body.theme-light thead th{ background:#f1f5f9 }
body.theme-light .title-block{background: linear-gradient(180deg,#ffffff,#f7fafc); color: var(--ink); border-left:8px solid var(--accent);} 
body.theme-light strong{ color: var(--ink); }
body.theme-light .callout{background:#f8fafc; border-left-color: var(--accent); color: var(--ink);} 
body.theme-light .grid{background:#fffd;} 
body.theme-light .thumb{background:#ffffff;} 
body.theme-light .quiz{background:#f8fafc;} 
body.theme-light .q-option{background:#ffffff;}

/* HIGH CONTRAST */
body.theme-contrast{
  --bg:#000; --panel:#000; --ink:#fff; --muted:#cbd5e1; --accent:#0ff; --accent-2:#ff0; --border:#666; --ui:#111; --img-opacity:0; --img-blur:0;
  --toolbar-bg:#0a0a0aee; --timeline-bg:#222; --timeline-active:#0ff; --timeline-done:#ff0;
}

/* Draw layer */
.draw-overlay{ position:fixed; right:18px; bottom:88px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:6px; z-index:55; display:none; box-shadow:var(--shadow); gap:6px; align-items:center; }
.draw-overlay.active{display:flex}
.draw-canvas-wrap{position:absolute; inset:64px 0 56px 0; z-index:5; pointer-events:none}
.draw-canvas-wrap.active{pointer-events:all}
#drawCanvas{width:100%; height:100%; display:block; cursor:crosshair;}
.draw-overlay .btn{padding:6px 8px; font-size:13px;}
.draw-overlay input[type="range"]{width:80px;}

/* Timer */
.timer{ position:fixed; right:18px; bottom:88px; background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; z-index:60; display:none; min-width:280px; }
.timer.active{display:block; animation: slideUp .25s ease}
@keyframes slideUp{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}
.timer .big{font-weight:900; font-size:36px; text-align:center; margin-bottom:12px}
.timer .row{display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0}
.timer input[type="number"]{width:80px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--ui); color:var(--ink)}
.timer .presets{display:flex; gap:4px; justify-content:center;} .timer .presets button{padding:6px 8px; font-size:13px;}

/* Help bubble */
.help{ position:fixed; left:18px; bottom:88px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; z-index:60; display:none; min-width:300px; }
.help.active{display:block}
.help h5{margin:0 0 8px 0; font-size:14px}
.help kbd{background:#0006; padding:.1em .4em; border-radius:6px; border:1px solid var(--border); font-size:12px}

/* Simulator */
.sim-wrap{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:20px 0;}
.sim-wrap.single{grid-template-columns:1fr}
.net{position:relative; background:linear-gradient(180deg, #0f172a, #0b1526); border:1px solid var(--border); border-radius:16px; min-height:320px;}
.net .label{position:absolute; top:10px; left:12px; font-weight:700; color:var(--muted)}
.host{position:absolute; width:72px; height:72px; border-radius:14px; background:var(--ui); border:1px solid var(--border); display:grid; place-items:center; font-weight:700; transition: all var(--transition);} 
.device{position:absolute; width:110px; height:64px; border-radius:14px; background:linear-gradient(180deg, #0ea5e9, #0284c7); border:2px solid #075985; color:white; display:grid; place-items:center; font-weight:800; text-transform:uppercase; letter-spacing:.5px;}
.link{position:absolute; height:2px; background:var(--border); transform-origin:left center;}
.pulse{position:absolute; width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 20px var(--accent); animation: pulse 1s linear;}
@keyframes pulse{from{opacity:1; transform:scale(1)} to{opacity:0; transform:scale(1.5)}}
.collision{position:absolute; inset:0; display:grid; place-items:center; font-weight:900; color:#fff; background:radial-gradient(circle at 50% 50%, #ef444488, transparent 50%); opacity:0; transition: opacity .2s;} .collision.show{opacity:1; animation: flash .5s ease;} @keyframes flash{0%,100%{opacity:0} 50%{opacity:1}}
.macbox{position:absolute; right:10px; bottom:10px; background:#0b1526; border:1px solid var(--border); border-radius:12px; padding:8px 10px; font-size:12px; color:var(--muted)}
.macbox table{font-size:12px; margin:6px 0 0} .macbox th,.macbox td{padding:4px 6px}

/* Mini-timer chip */
.mini-timer{display:inline-flex; align-items:center; gap:.4rem; font-variant-numeric:tabular-nums; font-weight:800;
  color:var(--accent); background:var(--ui); border:1px solid var(--border); border-radius:999px; padding:.25rem .6rem}
[hidden]{display:none !important}

/* Step indicator (inspiré v4) */
.step-indicator{ position:fixed; left:50%; transform:translateX(-50%); bottom:72px; display:none; gap:.35rem; z-index:45; background:var(--toolbar-bg); border:1px solid var(--border); border-radius:999px; padding:.3rem .6rem; }
.step-indicator .dot{ width:8px; height:8px; border-radius:999px; background:var(--timeline-bg); }
.step-indicator .dot.active{ background:var(--accent); }

/* A11y */
.sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
:focus-visible{ outline: var(--ring); outline-offset: 2px; }
</style>
</head>
<body>
<a class="sr-only" href="#viewport">Aller au contenu</a>
<div id="app" aria-describedby="live">
  <div class="deck-wrap">
    <div class="deck" id="deck" role="region" aria-label="Diaporama interactif">
      <div class="bar-top">
        <div class="brand">
          <div class="logo">
            <span class="icon">🌐</span>
            <span>Hub vs Switch</span>
          </div>
          <div class="sub">Bac Pro CIEL — Séance S1</div>
        </div>
        <div class="meta">
          <div class="badge"><span id="title">Réseaux L1/L2</span></div>
          <div class="badge" id="scoreBadge">Score <span id="score">—</span></div>
          <span id="miniTimer" class="mini-timer" hidden title="Cliquer pour ouvrir le minuteur" role="status" aria-live="polite">⏱ 00:00</span>
          <input class="input" id="studentName" placeholder="Nom élève (optionnel)" aria-label="Nom de l'élève"/>
        </div>
        <div class="controls">
          <button class="btn" id="themeBtn" aria-label="Changer de thème" title="Thème (Sombre/Clair/Contraste)">🎨 Thème</button>
          <!-- MODE: icône seule (pas d'affichage du label) -->
          <button class="btn" id="modeBtn" aria-label="Changer le mode d'affichage" title="Basculer Pas à pas / Complet / Auto">🎬 Mode</button>
          <button class="btn" id="settingsBtn" aria-expanded="false" aria-controls="panel" title="Réglages">⚙️ Réglages</button>
          <button class="btn" id="allBtn" aria-pressed="false" title="Affichage ‘Tout’ (impression)">📄 Tout afficher</button>
        </div>
      </div>

      <div class="content">
        <div class="bg-illus" id="bg" aria-hidden="true"></div>
        <div class="slide-viewport" id="viewport" role="group" aria-label="Zone de diapo"></div>
        <div class="grid" id="grid" aria-hidden="true"><div class="grid-inner" id="grid-inner"></div></div>
        <!-- Draw canvas -->
        <div class="draw-canvas-wrap" id="drawWrap"><canvas id="drawCanvas"></canvas></div>
      </div>

      <div class="footer">
        <div>
          ←/→ naviguer · G grille · F plein écran · P PDF · T minuteur · D annoter · ? aide · Espace suivant · ESC fermer
        </div>
        <div class="counter" id="counter" aria-live="polite">1 / 1</div>
      </div>
      <div class="progressbar"><div class="progress" id="progress"></div></div>
      <div class="timeline" id="timeline" aria-label="Timeline de progression"></div>
    </div>
  </div>

  <!-- Step indicator (dots) -->
  <div class="step-indicator" id="stepIndicator" aria-hidden="true"></div>

  <div class="toolbar" role="toolbar" aria-label="Barre d'actions">
    <button class="tbtn" id="prevBtn" title="Précédent (←)">◀</button>
    <button class="tbtn" id="nextBtn" title="Suivant (→)">▶</button>
    <button class="tbtn" id="gridBtn" title="Grille (G) — Aperçu des diapos">⊞</button>
    <button class="tbtn" id="fullscreenBtn" title="Plein écran (F)">⛶</button>
    <button class="tbtn" id="timerBtn" title="Minuteur (T)">⏱</button>
    <button class="tbtn" id="drawBtn" title="Annoter (D) — crayon/gomme">✏️</button>
    <button class="tbtn" id="pdfBtn" title="PDF/Imprimer (P)">📄</button>
    <button class="tbtn" id="exportBtn" title="Exporter le score (CSV/JSON)">📊</button>
    <button class="tbtn" id="resetBtn" title="Réinitialiser la session (RAZ)">♻︎</button>
  </div>

  <!-- Settings -->
  <div class="panel" id="panel" role="dialog" aria-modal="false" aria-label="Réglages">
    <h4>⚙️ Réglages</h4>
    <div class="row"><span>Mode actuel :</span><strong id="modeLabel2"></strong></div>
    <div class="row"><span>Auto‑avance :</span><input id="speed" type="range" min="2" max="10" step="1" value="3"/><span id="speedVal">3s</span></div>
    <div class="row switch"><input id="imgToggle" type="checkbox" checked/><label for="imgToggle">Images d'arrière‑plan</label></div>
    <div class="row switch"><input id="showCorr" type="checkbox" checked/><label for="showCorr">Afficher corrections quiz</label></div>
    <div class="row switch"><input id="showScore" type="checkbox" checked/><label for="showScore">Afficher score</label></div>
    <div class="row switch"><input id="showStudent" type="checkbox" checked/><label for="showStudent">Afficher champ élève</label></div>
    <div class="row switch"><input id="studentMode" type="checkbox"/><label for="studentMode">Mode élève (masquer 📄/📊/♻︎)</label></div>
    <div class="row"><span>Élève :</span><input id="studentPanel" class="input" placeholder="Nom élève"/></div>
    <div class="row"><small id="img-credit"></small></div>
  </div>

  <!-- Timer -->
  <div class="timer" id="timer" role="dialog" aria-modal="false" aria-live="polite" aria-label="Minuteur">
    <div class="big" id="timerDisplay">00:00</div>
    <div class="row">
      <input type="number" id="minInput" min="0" max="99" value="5" aria-label="minutes">
      <span>:</span>
      <input type="number" id="secInput" min="0" max="59" value="0" aria-label="secondes">
    </div>
    <div class="presets">
      <button class="btn" data-preset="120">2min</button>
      <button class="btn" data-preset="300">5min</button>
      <button class="btn" data-preset="600">10min</button>
    </div>
    <div class="row">
      <button class="btn" id="startTimer">▶ Start</button>
      <button class="btn" id="pauseTimer">⏸ Pause</button>
      <button class="btn" id="resetTimer">⟲ Reset</button>
    </div>
  </div>

  <!-- Help -->
  <div class="help" id="help" role="dialog" aria-modal="false" aria-label="Aide clavier">
    <h5>Raccourcis</h5>
    <div><kbd>←</kbd>/<kbd>→</kbd> navigation · <kbd>Espace</kbd> suivant</div>
    <div><kbd>G</kbd> grille · <kbd>F</kbd> plein écran · <kbd>P</kbd> PDF</div>
    <div><kbd>T</kbd> minuteur · <kbd>D</kbd> annoter · <kbd>?</kbd> aide</div>
    <div>Quiz : <kbd>1–9</kbd> sélection · <kbd>Entrée</kbd>/<kbd>Espace</kbd> valider</div>
    <div><kbd>ESC</kbd> ferme panneaux</div>
  </div>

  <!-- Draw Overlay (compacte) -->
  <div class="draw-overlay" id="drawOverlay" aria-label="Outils d'annotation">
    <button class="btn" id="penClear" title="Effacer">🧽</button>
    <input id="penSize" type="range" min="2" max="12" value="3" title="Épaisseur"/>
    <input id="penColor" type="color" value="#60a5fa" title="Couleur"/>
    <button class="btn" id="penSave" title="Sauvegarder">💾</button>
  </div>

  <!-- All-in-one print root -->
  <div id="printRoot"></div>
</div>

<!-- Accessible live region -->
<div id="live" class="sr-only" aria-live="polite"></div>

<!-- ============ CONTENT (Markdown source) ============ -->
<script id="md" type="text/plain"># 🚀 HUB vs SWITCH - Comprendre les fondamentaux

---

## 📊 Constats du TP Packet Tracer

**Ce que vous avez observé :**

**Avec le Hub :**
- Trafic répliqué sur **tous** les ports
- **Collisions** fréquentes (CSMA/CD, half‑duplex)
- Débit **partagé** qui chute

**Avec le Switch :**
- Trames vers le port **ciblé** uniquement (unicast)
- **Table MAC** apprise automatiquement
- Performances **stables** (full‑duplex)

---

## 🔍 Où ça se passe dans l'OSI ?

| Équipement | Couche OSI | Fonction |
|------------|------------|----------|
| **Hub** | 1 - Physique | Répéteur multi-ports |
| **Switch** | 2 - Liaison | Commutation MAC |

**Conséquence :** Le hub = **1 domaine de collision**. Le switch = **1 domaine par port**.

---

## 🧪 Mini-simulateur — Hub

<div class="sim-wrap single">
  <div class="net" id="netHub">
    <div class="label">Hub</div>
    <div class="device" style="left:calc(50% - 55px); top:calc(50% - 32px)">HUB</div>
    <div class="host" id="hA" style="left:40px; top:40px">A</div>
    <div class="host" id="hB" style="right:40px; top:40px">B</div>
    <div class="host" id="hC" style="left:40px; bottom:40px">C</div>
    <div class="host" id="hD" style="right:40px; bottom:40px">D</div>
    <div class="collision" id="colHub">💥 COLLISION</div>
  </div>
</div>

**Cliquez pour simuler :**
<button onclick="simHub()">Hub: A→Tous (broadcast)</button>
<button onclick="simHubCollision()">Hub: Collision A & C</button>
<button onclick="resetSim()">Réinitialiser</button>

---

## 🧪 Mini-simulateur — Switch

<div class="sim-wrap single">
  <div class="net" id="netSw">
    <div class="label">Switch</div>
    <div class="device" style="left:calc(50% - 55px); top:calc(50% - 32px); background:linear-gradient(180deg, #10b981, #059669); border-color:#065f46">SWITCH</div>
    <div class="host" id="sA" style="left:40px; top:40px">A</div>
    <div class="host" id="sB" style="right:40px; top:40px">B</div>
    <div class="host" id="sC" style="left:40px; bottom:40px">C</div>
    <div class="host" id="sD" style="right:40px; bottom:40px">D</div>
    <div class="macbox" id="macBox">
      <div>Table MAC (apprentissage)</div>
      <table><thead><tr><th>MAC</th><th>Port</th></tr></thead><tbody id="macBody"></tbody></table>
    </div>
  </div>
</div>

**Cliquez pour simuler :**
<button onclick="simSwitch()">Switch: A→B (learn & unicast)</button>
<button onclick="resetSim()">Réinitialiser</button>

---

## ❓ Quiz 1 : Couche OSI

**À quelle couche OSI fonctionne un hub ?**

- (x) Couche 2 (Liaison)
- (✓) Couche 1 (Physique)
- (x) Couche 3 (Réseau)

---

## ❓ Quiz 2 : Décision de commutation

**Comment un switch décide où envoyer une trame ?**

- (✓) Via sa table MAC
- (x) Par l'adresse IP
- (x) En diffusant partout

---

## 🔒 Aspect Sécurité

**Hub = Risque**
- Sniffing trivial (tout est diffusé)
- Aucune isolation

**Switch = Protection basique**
- Communication point‑à‑point, isolation par port
- ⚠️ Restent possibles : ARP spoofing / usurpation MAC  
  _Mitigations :_ port‑security, DHCP Snooping, DAI (Dynamic ARP Inspection)

---

## 📈 Impact Performance (ordres de grandeur)

| Métrique | Hub | Switch |
|----------|-----|--------|
| **Débit** | 10 Mb/s **partagés** (typiquement) | **par port** (100 Mb/s, 1 Gb/s, …) |
| **Duplex** | Half‑duplex | Full‑duplex (selon cartes/config) |
| **Collisions** | Possibles | **0 %** |
| **Latence de traversée** | ~0,1–1 µs (répéteur) + backoff | ~3–10 µs (store‑and‑forward) |

---

## ✅ Check‑list des compétences

- [x] Distinguer Hub (L1) vs Switch (L2)
- [x] Comprendre les domaines de collision
- [x] Analyser une table MAC
- [ ] Configurer un VLAN (prochaine séance)

---

## 🎯 Conclusion

> **À retenir :** Le switch élimine les collisions par **micro‑segmentation** (un domaine par port) et **full‑duplex**.

**Compétence validée :** C04 (N1) - Analyse des flux réseau

**Prochaine séance :** Câblage RJ45 & normes TIA‑568

---

## 🖼️ Illustration

![Châssis de switch niveau 2](https://upload.wikimedia.org/wikipedia/commons/3/3d/Network_switches.jpg)

</script>

<!-- ============ ENGINE HELPERS (déplacés AVANT l'IIFE) ============ -->
<script>
/* Stockage safe */
const safeStore = {
  get(k){ try{return localStorage.getItem(k)}catch(e){return null} },
  set(k,v){ try{localStorage.setItem(k,v)}catch(e){} },
  del(k){ try{localStorage.removeItem(k)}catch(e){} }
};

// Images décor
const IMG_MANIFEST = [
  {"src":"https://upload.wikimedia.org/wikipedia/commons/3/3d/Network_switches.jpg","title":"Switchs réseau","credit":"Wikimedia Commons"},
  {"src":"https://upload.wikimedia.org/wikipedia/commons/1/1c/EthernetSwitch.jpg","title":"Switch Ethernet","credit":"Wikimedia Commons"},
  {"src":"https://upload.wikimedia.org/wikipedia/commons/e/ed/AlliedTelesis_Hub_MR820TR.jpg","title":"Hub 10 Mbit/s","credit":"Wikimedia Commons"}
];
IMG_MANIFEST.forEach(i=>{ const l = new Image(); l.decoding='async'; l.src=i.src; });

/* Markdown → HTML (standard + quiz + checklists + HTML brut) */
function parseMarkdown(md){
  md = md.replace(/\r/g,'');
  const pieces = md.split(/\n-{3,}\n/g); // '---' sépare les diapos
  return pieces.map(blockToHtml);
}
function mdEscape(s){ return s.replace(/[&<>]/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch])); }
function mdInline(s){
  return s
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`([^`]+?)`/g,'<code class="kbd">$1</code>')
    .replace(/$begin:math:display$([^$end:math:display$]+?)\]$begin:math:text$(https?:\\/\\/[^\\s)]+)$end:math:text$/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
}
function blockToHtml(block){
  const lines = block.split('\n'); let i=0, html=''; let lastH='Question';

  function peekList(regex){ const out=[]; let j=i; while(j<lines.length && regex.test(lines[j])){ out.push(lines[j]); j++; } return out; }

  function consumeList(regex, tag){
    const preview = peekList(regex);
    // Quiz: - (✓) / - (x)
    const isQuiz = preview.some(l => /^\s*[-*]\s*$begin:math:text$(?:✓|x|X)$end:math:text$\s+/.test(l));
    if(isQuiz){
      let items=[]; let correctCount=0;
      while(i<lines.length && regex.test(lines[i])){
        const raw = lines[i];
        const m = raw.match(/^\s*[-*]\s*$begin:math:text$(✓|x|X)$end:math:text$\s+(.*)$/);
        if(m){
          const ok = m[1]==='✓'; if(ok) correctCount++;
          items.push({html: mdInline(m[2].trim()), ok});
          i++;
        }else{
          const txt = raw.replace(regex,'').trim();
          items.push({html: mdInline(txt), ok:null}); i++;
        }
      }
      const mode = correctCount>1 ? 'multi' : 'single';
      let out = `<div class="quiz" data-mode="${mode}" role="group" aria-label="Question à choix" aria-live="off">
        <div class="q-title">${mdEscape(lastH)}</div>
        <div class="q-options" role="listbox" ${mode==='multi'?'aria-multiselectable="true"':''}>`;
      items.forEach((it,idx)=>{
        const cls = it.ok===true?'correct':(it.ok===false?'wrong':'neutral');
        out += `<div class="q-option ${cls}" data-idx="${idx}" role="option" aria-selected="false" tabindex="0">${it.html}</div>`;
      });
      out += `</div><div class="q-actions"><button class="btn q-check">Vérifier</button><button class="btn q-reset">Réinitialiser</button></div></div>`;
      return out;
    }
    // Checklists: - [ ] / - [x]
    let out = `<${tag}>`;
    while(i<lines.length && regex.test(lines[i])){
      const raw = lines[i];
      const mcb = raw.match(/^\s*[-*]\s+$begin:math:display$( |x|X)$end:math:display$\s+(.*)$/);
      if(mcb){
        const checked = /x/i.test(mcb[1]); const text = mdInline(mcb[2].trim());
        out += `<li class="check fragment"><input type="checkbox" ${checked?'checked':''}><label>${text}</label></li>`; i++; continue;
      }
      const item = raw.replace(regex, ''); out += `<li class="fragment">${mdInline(item.trim())}</li>`; i++;
    }
    out += `</${tag}>`; return out;
  }

  function consumeTable(){
    let rows=[]; while(i<lines.length && /^\|.*\|$/.test(lines[i].trim())){ rows.push(lines[i].trim()); i++; }
    if(rows.length<2) return '';
    const header = rows[0].slice(1,-1).split('|').map(s=>s.trim());
    const bodyRows = rows.slice(1).filter(r=>!/^-+\|/.test(r));
    const tbody = bodyRows.map(r => r.slice(1,-1).split('|').map(s=>s.trim()));
    let out = '<table><thead><tr>'; header.forEach(h => out += `<th>${mdInline(h)}</th>`); out += '</tr></thead><tbody>';
    tbody.forEach(cols => { out += '<tr>' + cols.map(c=>`<td>${mdInline(c)}</td>`).join('') + '</tr>'; }); out += '</tbody></table>'; return out;
  }

  while(i<lines.length){
    let line = lines[i]; if(line.trim()===''){ i++; continue; }
    if(/^#{1,3}\s/.test(line)){ const level = (line.match(/^#+/)[0] || '#').length; const content = line.replace(/^#{1,6}\s/, ''); lastH = content; html += `<h${Math.min(level,3)}>${mdInline(content)}</h${Math.min(level,3)}>`; i++; continue; }
    if(/^\s*[-*]\s+/.test(line)){ html += consumeList(/^\s*[-*]\s+/, 'ul'); continue; }
    if(/^\s*\d+\.\s+/.test(line)){ html += consumeList(/^\s*\d+\.\s+/, 'ol'); continue; }
    if(/^\s*\|.*\|$/.test(line.trim())){ html += consumeTable(); continue; }
    if(/^\s*>\s?/.test(line)){ html += `<div class="callout">${mdInline(line.replace(/^\s*>\s?/, ''))}</div>`; i++; continue; }
    if(/^\s*!$begin:math:display$[^$end:math:display$]*\]$begin:math:text$(https?:\\/\\/[^\\s)]+)$end:math:text$/.test(line)){
      const m = line.match(/^\s*!$begin:math:display$([^$end:math:display$]*)\]$begin:math:text$(https?:\\/\\/[^\\s)]+)$end:math:text$/); 
      html += `<figure><img src="${m[2]}" alt="${mdEscape(m[1]||'Illustration')}" loading="lazy"><figcaption>${mdEscape(m[1]||'')}</figcaption></figure>`; i++; continue;
    }
    // Pass-through HTML blocks (simulateur & boutons)
    if(/^\s*</.test(line)){ html += line; i++; continue; }
    html += `<p class="fragment">${mdInline(line)}</p>`; i++;
  }
  return html;
}

/* ===== Simulateur : liens ===== */
const linkRegistry = [];
function positionLink(el, a, b){
  const nr = el.parentElement.getBoundingClientRect();
  const ar = a.getBoundingClientRect(), br = b.getBoundingClientRect();
  const ax = ar.left + ar.width/2 - nr.left, ay = ar.top + ar.height/2 - nr.top;
  const bx = br.left + br.width/2 - nr.left, by = br.top + br.height/2 - nr.top;
  const dx = bx-ax, dy=by-ay; const len = Math.hypot(dx,dy); const angle=Math.atan2(dy,dx)*180/Math.PI;
  el.style.width = len+'px'; el.style.left=ax+'px'; el.style.top=ay+'px'; el.style.transform=`rotate(${angle}deg)`;
}
function setupLinks(netId, deviceSel, hostIds){
  const net = document.getElementById(netId); if(!net) return;
  const device = net.querySelector(deviceSel);
  hostIds.forEach(id=>{
    const host = document.getElementById(id); if(!host) return;
    const link = document.createElement('div'); link.className='link'; net.appendChild(link);
    positionLink(link, host, device);
    linkRegistry.push({el:link, a:host, b:device});
  });
}
function positionAllLinks(){ linkRegistry.forEach(L=> positionLink(L.el, L.a, L.b)); }
let linksSetup=false; function setupLinksIfAny(){ if(linksSetup) return; const hub = document.getElementById('netHub'), sw = document.getElementById('netSw'); if(hub && sw){ setupLinks('netHub', '.device', ['hA','hB','hC','hD']); setupLinks('netSw', '.device', ['sA','sB','sC','sD']); linksSetup=true; } }

// SELF-TESTS
(function selftests(){
  try{ console.assert(Array.isArray(linkRegistry), 'linkRegistry doit être un tableau'); }catch(e){ console.warn('Selftest linkRegistry', e); }
  try{ positionAllLinks(); }catch(e){ console.error('positionAllLinks() ne doit pas jeter quand registre vide', e); }
})();
</script>

<!-- ============ ENGINE (IIFE) ============ -->
<script>
(function(){
  const deck = document.getElementById('deck');
  const grid = document.getElementById('grid');
  const gridInner = document.getElementById('grid-inner');
  const progress = document.getElementById('progress');
  const counter = document.getElementById('counter');
  const titleEl = document.getElementById('title');
  const scoreEl = document.getElementById('score');
  const scoreBadge = document.getElementById('scoreBadge');
  const studentField = document.getElementById('studentName');
  const live = document.getElementById('live');
  const help = document.getElementById('help');
  const miniTimerChip = document.getElementById('miniTimer');
  const timeline = document.getElementById('timeline');
  const stepIndicator = document.getElementById('stepIndicator');

  const raw = document.getElementById('md').textContent;
  const slidesHtml = parseMarkdown(raw);
  const slides = [];
  const viewport = document.getElementById('viewport');

  slidesHtml.forEach((html, idx) => {
    const s = document.createElement('section'); s.className = 'slide';
    if(idx===0){
      const h1m = html.match(/<h1>([\s\S]*?)<\/h1>/); const h1 = h1m? h1m[1] : 'Séance';
      const rest = h1m? html.replace(/^<h1>[\s\S]*?<\/h1>/, '') : html;
      s.innerHTML = `<div class="title-block"><h1>${h1}</h1></div>${rest}`;
      titleEl.textContent = h1.replace(/<[^>]+>/g,'').substring(0,20);
    }else{ s.innerHTML = html; }
    viewport.appendChild(s); slides.push(s);
  });

  // Images de fond
  const bg = document.getElementById('bg');
  const credit = document.getElementById('img-credit');
  function setBgForSlide(i){ if(!IMG_MANIFEST.length) return; const item = IMG_MANIFEST[i % IMG_MANIFEST.length]; bg.style.backgroundImage = `url('${item.src}')`; if(credit) credit.textContent = `${item.title} — ${item.credit}`; }

  // Grid
  function buildGrid(){ gridInner.innerHTML=''; slides.forEach((s,i)=>{ const card = document.createElement('div'); card.className='thumb'; card.innerHTML = `<div class="num">Diapo ${i+1}</div><div class="mini"><div class="mini-inner">${s.innerHTML}</div></div>`; card.onclick = ()=>{ grid.classList.remove('active'); go(i, true); }; gridInner.appendChild(card); }); }
  buildGrid();

  // Timeline segments (1 par diapo)
  function buildTimeline(){
    timeline.innerHTML='';
    for(let i=0;i<slides.length;i++){
      const seg = document.createElement('div');
      seg.className='seg'; seg.title = `Aller à la diapo ${i+1}`;
      seg.addEventListener('click', ()=> go(i, true));
      timeline.appendChild(seg);
    }
  }
  buildTimeline();

  // State
  let mode = 'step'; let autoTimer = null; let autoDelay = 3000; let idx = 0; let fragIndex = 0;
  const storageKey = 'deck:hub-vs-switch:v3.5.0';

  // Quiz score
  let global = { total:0, correct:0 }; const quizLog = [];
  function refreshScore(){ scoreEl.textContent = global.total ? (global.correct + '/' + global.total) : '—'; }

  // Quiz binder (idempotent)
  function bindQuiz(scope){
    scope.querySelectorAll('.quiz').forEach(q=>{
      if(q.dataset.bound==='1') return; q.dataset.bound='1';
      const options = [...q.querySelectorAll('.q-option')];
      const btnCheck = q.querySelector('.q-check');
      const btnReset = q.querySelector('.q-reset');
      const mode = q.dataset.mode || 'single';
      q.dataset.scored = q.dataset.scored || '0';

      function toggleOption(opt){ if(mode==='single'){ options.forEach(o=>{ o.classList.remove('selected'); o.setAttribute('aria-selected','false'); }); opt.classList.add('selected'); opt.setAttribute('aria-selected','true'); } else { const sel = opt.classList.toggle('selected'); opt.setAttribute('aria-selected', sel?'true':'false'); } }

      options.forEach((opt)=>{ opt.addEventListener('click', ()=> toggleOption(opt)); opt.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleOption(opt); } }); });

      function numKey(e){ const n = parseInt(e.key,10); if(!isNaN(n) && n>=1 && n<=options.length && scope.classList.contains('active')){ toggleOption(options[n-1]); } }
      if(!q.dataset.numListener){ document.addEventListener('keydown', numKey); q.dataset.numListener='1'; }

      btnCheck?.addEventListener('click', ()=>{
        const reveal = (safeStore.get(storageKey+':showCorr')||'1')==='1';
        if(reveal){ options.forEach(o=>{ if(o.classList.contains('correct')||o.classList.contains('wrong')) o.classList.add('show'); }); }
        if(q.dataset.scored==='0'){
          const selectedIdx = new Set(options.map((o,i)=> o.classList.contains('selected') ? i : -1).filter(i=>i>=0));
          const correctIdx  = new Set(options.map((o,i)=> o.classList.contains('correct') ? i : -1).filter(i=>i>=0));
          let hit = false;
          if(mode==='single'){ hit = selectedIdx.size===1 && [...selectedIdx][0]===[...correctIdx][0]; }
          else{ const eq = selectedIdx.size===correctIdx.size && [...selectedIdx].every(v=>correctIdx.has(v)); hit = selectedIdx.size>0 && eq; }
          global.total += 1; if(hit) global.correct += 1; q.dataset.scored='1'; refreshScore();
          live.textContent = hit ? 'Bonne réponse !' : 'Réponse incorrecte.';
          quizLog.push({slide: idx+1, result: hit?1:0, mode});
        }
      });

      btnReset?.addEventListener('click', ()=>{ options.forEach(o=>{ o.classList.remove('selected','show'); o.setAttribute('aria-selected','false'); }); q.dataset.scored='0'; });
    });

    // Checklists persistantes
    scope.querySelectorAll('.check input').forEach((cb,j)=>{ const key = storageKey + `:s${idx}:c${j}`; const saved = safeStore.get(key); if(saved!==null) cb.checked = (saved==='1'); cb.onchange = ()=> safeStore.set(key, cb.checked?'1':'0'); });
  }

  // Step indicator (dots)
  function updateStepDots(){
    const current = slides[idx];
    const fragments = [...current.querySelectorAll('.fragment')];
    const show = (mode==='step' || mode==='auto') && fragments.length>0;
    stepIndicator.style.display = show ? 'flex' : 'none';
    if(!show) return;
    let html='';
    for(let i=0;i<=fragments.length;i++){
      html += `<span class="dot ${i<=fragIndex?'active':''}"></span>`;
    }
    stepIndicator.innerHTML = html;
  }

  // Update
  function update(){
    slides.forEach((s,i)=> s.classList.toggle('active', i===idx));
    const current = slides[idx];
    const fragments = [...current.querySelectorAll('.fragment')];
    if(mode==='full'){ fragIndex = fragments.length; }
    fragments.forEach((f,i)=> f.classList.toggle('visible', i<fragIndex));
    bindQuiz(current);
    const percent = ((idx + 1) / slides.length); progress.style.width = (percent*100)+'%';
    counter.textContent = `${idx+1} / ${slides.length}`;
    setBgForSlide(idx);
    // timeline
    [...timeline.children].forEach((seg,i)=>{ seg.classList.toggle('done', i<idx); seg.classList.toggle('active', i===idx); });
    safeStore.set(storageKey+':slide', idx.toString());
    setupLinksIfAny(); numberAllViewPages(); updateStepDots();
  }
  function next(){ const current = slides[idx]; const fr=[...current.querySelectorAll('.fragment')]; if(mode==='step' || mode==='auto'){ if(fragIndex < fr.length){ fragIndex++; update(); return; } } if(idx < slides.length-1){ idx++; fragIndex=0; update(); } }
  function prev(){ if(fragIndex>0 && (mode==='step' || mode==='auto')){ fragIndex=0; update(); return; } if(idx>0){ idx--; fragIndex=0; update(); } }
  function go(n, reset){ idx=Math.max(0,Math.min(slides.length-1,n)); if(reset) fragIndex=0; update(); }

  // Theme
  function setTheme(name){ document.body.classList.remove('theme-light','theme-contrast'); if(name==='light') document.body.classList.add('theme-light'); if(name==='contrast') document.body.classList.add('theme-contrast'); safeStore.set(storageKey+':theme', name); document.getElementById('themeBtn').textContent = '🎨 ' + (name==='light'?'Clair':(name==='contrast'?'Contraste':'Sombre')); }
  function cycleTheme(){ const cur = safeStore.get(storageKey+':theme') || 'dark'; const next = cur==='dark' ? 'light' : (cur==='light' ? 'contrast' : 'dark'); setTheme(next); }

  // Mode (aucune affiche dans l'en-tête)
  function setMode(m){
    mode = m;
    const label = (m==='step'?'Pas à pas':(m==='full'?'Complet':'Auto'));
    const ml2 = document.getElementById('modeLabel2'); if(ml2) ml2.textContent = label;
    const ml1 = document.getElementById('modeLabel'); if(ml1) ml1.textContent = label;
    if(mode==='auto') startAuto(); else stopAuto();
    safeStore.set(storageKey+':mode', m);
    update();
  }
  function cycleMode(){ const modes = ['step', 'full', 'auto']; setMode(modes[(modes.indexOf(mode)+1)%3]); }
  function startAuto(){ stopAuto(); autoTimer = setInterval(()=>{ const current = slides[idx]; const fr=[...current.querySelectorAll('.fragment')]; if(fragIndex < fr.length){ fragIndex++; update(); return; } if(idx < slides.length-1){ idx++; fragIndex=0; update(); return; } stopAuto(); }, autoDelay); }
  function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }

  // Settings
  document.getElementById('settingsBtn').addEventListener('click', ()=>{ document.getElementById('panel').classList.toggle('active'); });
  const speedRange = document.getElementById('speed'); const speedValue = document.getElementById('speedVal');
  speedRange.addEventListener('input', ()=>{ autoDelay = Number(speedRange.value) * 1000; speedValue.textContent = speedRange.value + 's'; safeStore.set(storageKey+':speed', speedRange.value); if(mode==='auto'){ startAuto(); } });
  const imgToggle = document.getElementById('imgToggle'); imgToggle.addEventListener('change', ()=>{ document.documentElement.style.setProperty('--img-opacity', imgToggle.checked ? '.12' : '0'); safeStore.set(storageKey+':img', imgToggle.checked?'1':'0'); });
  const showCorr = document.getElementById('showCorr'); showCorr.addEventListener('change', ()=>{ safeStore.set(storageKey+':showCorr', showCorr.checked?'1':'0'); });

  // Toggles UI
  const showScore = document.getElementById('showScore');
  const showStudent = document.getElementById('showStudent');
  const studentMode = document.getElementById('studentMode');
  function applyUiToggles(){
    scoreBadge.style.display = showScore.checked ? '' : 'none';
    studentField.style.display = showStudent.checked ? '' : 'none';
    ['pdfBtn','exportBtn','resetBtn'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.style.display = studentMode.checked ? 'none' : '';
    });
    safeStore.set(storageKey+':ui', JSON.stringify({score:showScore.checked, student:showStudent.checked, smode:studentMode.checked}));
  }
  showScore.addEventListener('change', applyUiToggles);
  showStudent.addEventListener('change', applyUiToggles);
  studentMode.addEventListener('change', applyUiToggles);

  // Élève
  const studentName = document.getElementById('studentName'); const studentPanel = document.getElementById('studentPanel');
  function syncStudent(val){ if(studentName) studentName.value = val || ''; if(studentPanel) studentPanel.value = val || ''; safeStore.set(storageKey+':student', val||''); }
  studentName?.addEventListener('input', ()=> syncStudent(studentName.value)); studentPanel?.addEventListener('input', ()=> syncStudent(studentPanel.value));

  // All view (impression)
  const allBtn = document.getElementById('allBtn'); const allView = document.getElementById('printRoot');
  allBtn.addEventListener('click', ()=>{ const on = document.body.classList.toggle('allinone'); allBtn.setAttribute('aria-pressed', on?'true':'false'); if(on){ allView.innerHTML=''; slides.forEach((s, i)=>{ const clone = s.cloneNode(true); clone.querySelectorAll('.fragment').forEach(f=> f.classList.add('visible')); clone.classList.add('slide'); clone.style.background='var(--panel)'; clone.style.border='1px solid var(--border)'; clone.style.borderRadius='12px'; clone.style.margin='0 0 18px'; clone.style.padding='28px 56px'; const pn = document.createElement('div'); pn.className='page-num'; pn.textContent = `Diapo ${i+1}`; clone.appendChild(pn); allView.appendChild(clone); }); } });
  function numberAllViewPages(){ if(!document.body.classList.contains('allinone')) return; [...document.querySelectorAll('#printRoot .page-num')].forEach((n,i)=> n.textContent = `Diapo ${i+1}`); }

  // Minuteur + mini‑chip
  const timer = document.getElementById('timer'); const timerDisplay = document.getElementById('timerDisplay'); const minInput = document.getElementById('minInput'); const secInput = document.getElementById('secInput');
  let countdown = 0, timerHandle=null; function fmt(n){ return String(n).padStart(2,'0'); }
  function renderTimer(){ const m = Math.floor(countdown/60), s = countdown%60; const text = `${fmt(m)}:${fmt(s)}`; timerDisplay.textContent = text; miniTimerChip.textContent = `⏱ ${text}`; }
  function beep(){ try{ const AC = window.AudioContext || window.webkitAudioContext; const ac = new AC(); const o = ac.createOscillator(); const g = ac.createGain(); o.type='sine'; o.frequency.value = 880; o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0.0001, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.3, ac.currentTime+0.02); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.3); o.stop(ac.currentTime+0.35); ac.close(); }, 350); }catch(e){} navigator.vibrate?.(150); }
  function startTimer(){ if(timerHandle) return; countdown = (parseInt(minInput.value)||0)*60 + (parseInt(secInput.value)||0); renderTimer(); if(countdown<=0) return; miniTimerChip.hidden = false; timerHandle = setInterval(()=>{ if(countdown>0){ countdown--; renderTimer(); } else{ stopTimer(); beep(); miniTimerChip.hidden = true; } }, 1000); }
  function stopTimer(){ if(timerHandle){ clearInterval(timerHandle); timerHandle=null; } }
  function resetTimer(){ stopTimer(); countdown=0; renderTimer(); miniTimerChip.hidden = true; }
  document.getElementById('timerBtn').addEventListener('click', ()=> timer.classList.toggle('active'));
  document.getElementById('startTimer').addEventListener('click', startTimer);
  document.getElementById('pauseTimer').addEventListener('click', ()=>{ stopTimer(); /* conserver l'affichage */ });
  document.getElementById('resetTimer').addEventListener('click', resetTimer);
  document.querySelectorAll('[data-preset]').forEach(b=>{ b.addEventListener('click', ()=>{ const s=parseInt(b.dataset.preset,10)||0; minInput.value = Math.floor(s/60); secInput.value = s%60; }); });
  miniTimerChip.addEventListener('click', ()=> timer.classList.toggle('active'));

  // Annotation
  const drawWrap = document.getElementById('drawWrap'); const drawCanvas = document.getElementById('drawCanvas'); const drawOverlay = document.getElementById('drawOverlay');
  let penOn = false, drawing=false, ctx=null, last=null;
  function initCanvas(){ const r = drawWrap.getBoundingClientRect(); drawCanvas.width = r.width; drawCanvas.height = r.height; ctx = drawCanvas.getContext('2d'); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=document.getElementById('penColor').value; ctx.lineWidth = parseInt(document.getElementById('penSize').value,10)||3; }
  document.getElementById('drawBtn').addEventListener('click', ()=>{ penOn = !penOn; drawWrap.classList.toggle('active', penOn); drawOverlay?.classList.toggle('active', penOn); if(penOn) initCanvas(); });
  document.getElementById('penClear')?.addEventListener('click', ()=>{ if(ctx) ctx.clearRect(0,0, drawCanvas.width, drawCanvas.height); });
  document.getElementById('penSize')?.addEventListener('input', (e)=>{ if(ctx) ctx.lineWidth = parseInt(e.target.value,10)||3; });
  document.getElementById('penColor')?.addEventListener('input', (e)=>{ if(ctx) ctx.strokeStyle = e.target.value; });
  document.getElementById('penSave')?.addEventListener('click', ()=>{ const url = drawCanvas.toDataURL('image/png'); const a = document.createElement('a'); a.href=url; a.download = `annotation_s${idx+1}.png`; a.click(); });

  function getPos(e){ const r = drawCanvas.getBoundingClientRect(); const px = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const py = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x:px, y:py}; }
  drawCanvas.addEventListener('mousedown', (e)=>{ if(!penOn) return; drawing=true; last=getPos(e); e.preventDefault(); });
  drawCanvas.addEventListener('mousemove', (e)=>{ if(!drawing||!penOn) return; const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault(); });
  window.addEventListener('mouseup', ()=> drawing=false);
  drawCanvas.addEventListener('touchstart', (e)=>{ if(penOn){ drawing=true; last=getPos(e); e.preventDefault(); }}, {passive:false});
  drawCanvas.addEventListener('touchmove', (e)=>{ if(drawing&&penOn){ const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault(); }}, {passive:false});
  drawCanvas.addEventListener('touchend', ()=> drawing=false);

  // Export score
  document.getElementById('exportBtn').addEventListener('click', ()=>{ const title = 'Hub vs Switch'; const now = new Date(); const iso = now.toISOString(); const percent = global.total ? Math.round((global.correct/global.total)*100) : 0; const student = safeStore.get(storageKey+':student')||''; let csv = `Date,Titre,Eleve,Total,Correct,Pourcentage\n${iso},${title},${student},${global.total},${global.correct},${percent}%`; const json = JSON.stringify({date:iso,title,student,total:global.total,correct:global.correct,percent,log:quizLog}, null, 2); [{name:`score_${iso.slice(0,10)}.csv`,data:csv,type:'text/csv'},{name:`score_${iso.slice(0,10)}.json`,data:json,type:'application/json'}].forEach(f=>{ const blob = new Blob([f.data], {type:f.type}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = f.name; a.click(); }); });

  // Reset deck
  document.getElementById('resetBtn').addEventListener('click', ()=>{ ['slide','theme','mode','speed','img','showCorr','student','ui'].forEach(k=> safeStore.del(storageKey+':'+k)); location.reload(); });

  // Navigation
  document.getElementById('prevBtn').onclick = prev; document.getElementById('nextBtn').onclick = next; document.getElementById('gridBtn').onclick = ()=> grid.classList.toggle('active');
  // Fullscreen deck
  async function toggleFullscreen(){
    try{
      if(!document.fullscreenElement && !document.webkitFullscreenElement){
        const el = deck;
        if(el.requestFullscreen) await el.requestFullscreen();
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen(); // Safari
      }else{
        if(document.exitFullscreen) await document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
      }
    }catch(e){ console.warn('Fullscreen error', e); }
  }
  document.getElementById('fullscreenBtn').onclick = toggleFullscreen;

  document.getElementById('pdfBtn').onclick = ()=> window.print();
  document.getElementById('themeBtn').addEventListener('click', cycleTheme);
  document.getElementById('modeBtn').addEventListener('click', cycleMode);

  // Clavier
  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight' || e.key===' '){ next(); e.preventDefault(); }
    if(e.key==='ArrowLeft'){ prev(); e.preventDefault(); }
    if(e.key.toLowerCase()==='g'){ grid.classList.toggle('active'); }
    if(e.key.toLowerCase()==='f'){ toggleFullscreen(); }
    if(e.key.toLowerCase()==='p'){ window.print(); }
    if(e.key.toLowerCase()==='t'){ document.getElementById('timer').classList.toggle('active'); }
    if(e.key.toLowerCase()==='d'){ document.getElementById('drawBtn').click(); }
    if(e.key==='?'){ help.classList.toggle('active'); }
    if(e.key==='Escape'){ document.getElementById('panel').classList.remove('active'); help.classList.remove('active'); document.getElementById('timer').classList.remove('active'); }
  });

  // Touch swipe
  let touchX=null; viewport.addEventListener('touchstart', (e)=>{ touchX=e.changedTouches[0].clientX; }, {passive:true});
  viewport.addEventListener('touchend', (e)=>{ if(touchX===null) return; const dx=e.changedTouches[0].clientX - touchX; if(Math.abs(dx)>60){ if(dx<0) next(); else prev(); } touchX=null; }, {passive:true});

  // Scale
  function scale(){ const w = window.innerWidth - 48, h = window.innerHeight - 140; const sx = Math.min(1.0, w/1280), sy = Math.min(1.0, h/720); const s = Math.min(sx, sy); deck.style.transform = `scale(${s})`; positionAllLinks(); }
  window.addEventListener('resize', scale); scale();

  // Restore
  const savedIdx = safeStore.get(storageKey+':slide'); if(savedIdx) idx = Math.min(slides.length-1, Math.max(0, parseInt(savedIdx,10)));
  const savedTheme = safeStore.get(storageKey+':theme'); if(savedTheme) setTheme(savedTheme); else setTheme('dark');
  const savedMode = safeStore.get(storageKey+':mode'); if(savedMode) setMode(savedMode); else setMode('step');
  const savedSpeed = safeStore.get(storageKey+':speed'); if(savedSpeed){ speedRange.value = savedSpeed; speedRange.dispatchEvent(new Event('input')); }
  const savedImg = safeStore.get(storageKey+':img'); if(savedImg){ imgToggle.checked = savedImg==='1'; imgToggle.dispatchEvent(new Event('change')); }
  const savedCorr = safeStore.get(storageKey+':showCorr'); if(savedCorr){ document.getElementById('showCorr').checked = savedCorr==='1'; }
  const savedStudent = safeStore.get(storageKey+':student'); if(savedStudent){ studentName.value=savedStudent; document.getElementById('studentPanel').value=savedStudent; }
  const savedUi = safeStore.get(storageKey+':ui'); if(savedUi){ try{ const u=JSON.parse(savedUi); showScore.checked = !!u.score; showStudent.checked = !!u.student; studentMode.checked = !!u.smode; }catch{} }
  applyUiToggles();

  update(); refreshScore();

  // HEALTHCHECKS
  try{ console.assert(document.getElementById('netHub'), 'netHub présent'); console.assert(document.getElementById('netSw'), 'netSw présent'); }catch(e){}
  try{ const fig = document.querySelector('figure img'); if(!fig){ console.warn('Illustration introuvable'); }
  }catch(e){}
})();
</script>

<!-- ============ SIMULATEUR : MAC learning ============ -->
<script>
// MAC learning
const MAC = {A:'02:00:00:00:00:0A', B:'02:00:00:00:00:0B', C:'02:00:00:00:00:0C', D:'02:00:00:00:00:0D'};
const PORT = {A:'1',B:'2',C:'3',D:'4'}; let swTable = {}; // mac -> port
function renderMac(){ const body = document.getElementById('macBody'); if(!body) return; body.innerHTML = ''; Object.keys(swTable).sort().forEach(mac=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${mac}</td><td>${swTable[mac]}</td>`; body.appendChild(tr); }); }
function resetSim(){ swTable = {}; renderMac(); document.querySelectorAll('.pulse').forEach(p=>p.remove()); const col = document.getElementById('colHub'); col?.classList.remove('show'); }
function pulseAt(container, x, y){ const p = document.createElement('div'); p.className='pulse'; p.style.left = x+'px'; p.style.top = y+'px'; container.appendChild(p); setTimeout(()=> p.remove(), 900); }
function centerOf(el){ const r = el.getBoundingClientRect(); const pr = el.parentElement.getBoundingClientRect(); return {x:r.left+r.width/2-pr.left, y:r.top+r.height/2-pr.top}; }
function simHub(){ const hub = document.getElementById('netHub'); if(!hub) return; hub.querySelectorAll('.host').forEach(h => { const c = centerOf(h); pulseAt(hub, c.x, c.y); }); }
function simHubCollision(){ const col = document.getElementById('colHub'); if(!col) return; col.classList.add('show'); setTimeout(()=> col.classList.remove('show'), 500); }
function simSwitch(){ const sw = document.getElementById('netSw'); if(!sw) return; const A = document.getElementById('sA'); const B = document.getElementById('sB'); const DVC = sw.querySelector('.device'); swTable[MAC.A] = PORT.A; const knowB = !!swTable[MAC.B]; const a = centerOf(A), b = centerOf(B), d = centerOf(DVC); pulseAt(sw, a.x, a.y); setTimeout(()=> pulseAt(sw, d.x, d.y), 120); setTimeout(()=>{ if(knowB){ pulseAt(sw, b.x, b.y); }else{ ['sB','sC','sD'].forEach((id,j)=>{ const t = centerOf(document.getElementById(id)); setTimeout(()=> pulseAt(sw, t.x, t.y), j*80); }); swTable[MAC.B] = PORT.B; } renderMac(); }, 240); }

// TESTS
(function tests(){ try{ console.assert(typeof simHub==='function' && typeof simSwitch==='function', 'Simulateur exposé'); }catch(e){} })();
</script>
</body>
</html>