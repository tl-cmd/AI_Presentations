<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S1 — Hub vs Switch - Présentation interactive (v5.2 — Fix thème & galerie & liens)</title>
<meta name="color-scheme" content="dark light"/>
<style>
/* =============================
   Hub vs Switch — v5.2
   — Démo repositionnée (objets centrés & liens recalculés)
   — Images élégantes: @img, @gallery (multi‑lignes & inline), lightbox, float + shape-outside
   — Step/Full/Auto, Timer chip, Annotations compactes
   — Thèmes: sombre/clair (contraste supprimé)
   ============================= */
:root{
  --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#9aa4b2;
  --accent:#60a5fa; --accent-2:#f59e0b; --ok:#10b981; --danger:#ef4444;
  --ring:0 0 0 3px #60a5fa33; --shadow:0 10px 30px rgba(0,0,0,.35);
  --ui:#111827; --border:#223046;
  --img-opacity:.12; --img-blur:2px;
  --font-size:20px; --radius:20px; --transition:.25s ease;
  --toolbar-bg: #111827ee;
  --timeline-bg:#132033; --timeline-active:#2563eb; --timeline-done:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 520px at 5% -20%, #1d4ed81a, transparent 60%),
    radial-gradient(900px 420px at 110% 120%, #f59e0b1a, transparent 60%),
    var(--bg);
  color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  -webkit-font-smoothing: antialiased; line-height:1.55; font-size: var(--font-size);
  transition: background var(--transition), color var(--transition);
}
@media (prefers-reduced-motion: reduce){ *{animation:none!important; transition:none!important} }

#app{height:100%; display:flex; flex-direction:column;}
.deck-wrap{flex:1; display:flex; align-items:center; justify-content:center; padding:24px 24px 110px;}
.deck{
  width:1280px; height:720px; position:relative; background:var(--panel);
  border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); transform-origin: top left;
  display:grid; grid-template-rows: 64px 1fr 56px; border:1px solid var(--border);
}

/* Header */
.bar-top{ display:flex; align-items:center; justify-content:space-between; padding:0 18px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0f172a,#0b1526); }
.brand{display:flex; align-items:center; gap:10px}
.logo{display:flex; gap:6px; align-items:center; font-weight:800; font-size:18px;}
.logo .icon{font-size:24px;}
.brand .sub{font-size:12px; color:var(--muted); margin-left:6px; font-weight:600}
.meta{display:flex; align-items:center; gap:10px}
.meta .badge{font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px; background:var(--ui); border:1px solid var(--border)}
.controls{display:flex; align-items:center; gap:8px}
.btn{background:var(--ui); border:1px solid var(--border); color:var(--ink); border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; transition: all var(--transition);} 
.btn:hover{box-shadow:var(--ring); transform:translateY(-1px);} 
.btn:active{transform:translateY(0)}
.btn[aria-pressed="true"]{outline:3px solid #60a5fa66}
.input{ background:var(--ui); border:1px solid var(--border); color:var(--ink); border-radius:10px; padding:6px 10px; font-weight:700; font-size:12px; min-width:180px; }

/* Content */
.content{position:relative; overflow:hidden;}
.bg-illus{ position:absolute; inset:0; pointer-events:none; z-index:0; background-position:center; background-size:cover; background-repeat:no-repeat; opacity: var(--img-opacity); filter: blur(var(--img-blur)); transition: opacity var(--transition), filter var(--transition); }
.slide-viewport{position:absolute; inset:0; padding:28px 56px 84px; /* +bottom pour éviter chevauchement timeline */ overflow:auto; z-index:1; touch-action: pan-y;}
.slide{display:none; min-height:100%} 
.slide.active{display:block; animation: slideIn .35s cubic-bezier(0.4, 0, 0.2, 1)}
@keyframes slideIn{from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:none}}

h1{font-size:44px; line-height:1.08; margin:0 0 6px 0}
h2{font-size:32px; line-height:1.14; margin:8px 0 8px}
h3{font-size:24px; margin:12px 0 8px}
p{margin:8px 0}
ul,ol{padding-left:26px; margin:10px 0}
li{margin:8px 0}
small{color:var(--muted)} strong{color:#fff}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#0006; padding:.1em .35em; border-radius:6px; border:1px solid var(--border)}

/* Images intégrées */
.img-inline { display:inline-block; max-width:100%; height:auto; border-radius:12px; border:1px solid var(--border); box-shadow:0 4px 12px rgba(0,0,0,.3); margin:12px 0; cursor:zoom-in; transition:all var(--transition); }
.img-inline:hover { transform:scale(1.02); box-shadow:0 8px 24px rgba(0,0,0,.4); }
.img-inline.small { max-width:300px; }
.img-inline.medium { max-width:500px; }
.img-inline.large { max-width:800px; }
.img-inline.full { max-width:100%; }

.img-gallery { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin:20px 0; }
.img-gallery img { width:100%; height:200px; object-fit:cover; border-radius:10px; border:1px solid var(--border); cursor:zoom-in; transition:all var(--transition); }
.img-gallery img:hover { transform:scale(1.05); box-shadow:0 8px 20px rgba(0,0,0,.4); }

.img-float-left { float:left; margin:0 20px 20px 0; max-width:40%; shape-outside: inset(0 round 12px); }
.img-float-right { float:right; margin:0 0 20px 20px; max-width:40%; shape-outside: inset(0 round 12px); }

.lightbox { position:fixed; inset:0; background:rgba(0,0,0,.95); z-index:9999; display:none; align-items:center; justify-content:center; padding:40px; cursor:zoom-out; backdrop-filter:blur(8px); }
.lightbox.active { display:flex; animation:fadeIn .25s ease; }
.lightbox img { max-width:100%; max-height:100%; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.8); }
.lightbox-caption { position:absolute; bottom:40px; left:50%; transform:translateX(-50%); background:var(--panel); border:1px solid var(--border); padding:12px 20px; border-radius:999px; font-size:14px; color:var(--ink); backdrop-filter:blur(12px); }
@keyframes fadeIn{from{opacity:0} to{opacity:1}}

.title-block{ background:linear-gradient(180deg,#1e293bcc,#111827cc); border:1px solid var(--border); color:#fff; padding:18px 22px; border-left:8px solid var(--accent); border-radius:12px; box-shadow:var(--shadow); }
.callout{display:flex; gap:12px; align-items:flex-start; background:#111827; border-left:6px solid var(--accent); padding:12px 14px; border-radius:10px; border:1px solid var(--border)}
figure{margin:14px 0; text-align:center}
figure img{max-width:100%; max-height:420px; border-radius:12px; border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.35)}
figure figcaption{font-size:12px; color:var(--muted); margin-top:6px}

/* Tables */
table{width:100%; border-collapse:collapse; margin:10px 0 6px}
th,td{border:1px solid var(--border); padding:8px 10px; text-align:left}
thead th{background:#0b1526}

/* Footer */
.footer{display:flex; align-items:center; justify-content:space-between; padding:0 18px; border-top:1px solid var(--border); background:#0b1526; color:var(--muted); font-size:13px}
.counter{font-weight:800; color:var(--accent)}
.progressbar{height:6px; width:100%; background:#132033; border-top:1px solid var(--border)}
.progress{height:100%; width:0; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transform-origin:left; transition:width var(--transition);}

.timeline{position:absolute; left:18px; right:18px; bottom:62px; height:12px; display:grid; gap:4px; grid-auto-flow:column; background:transparent; pointer-events:auto}
.timeline .seg{background:var(--timeline-bg); border:1px solid var(--border); border-radius:999px; height:100%; cursor:pointer; transition:transform .15s}
.timeline .seg:hover{transform:translateY(-1px); box-shadow:var(--ring)}
.timeline .seg.done{background:var(--timeline-done)}
.timeline .seg.active{background:var(--timeline-active)}

.grid{position:absolute; inset:0; background:#000e; display:none; padding:22px; z-index:10; backdrop-filter:blur(12px);} .grid.active{display:block; animation:fadeIn .3s ease}
.grid-inner{display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:14px; align-items:start; overflow-y:auto; max-height:100%;}
.thumb{background:#0b1526; border:1px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer; transition:all var(--transition);} .thumb:hover{box-shadow:var(--ring); transform:scale(1.03);} .thumb .num{font-weight:800; padding:8px 10px; color:var(--muted); font-size:12px} .thumb .mini{width:100%; aspect-ratio:16/9; background:#0f172a; position:relative; overflow:hidden} .thumb .mini-inner{position:absolute; inset:0; transform:scale(.22); transform-origin: top left; padding:18px 26px; pointer-events:none;}

.toolbar{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; display:flex; gap:8px; z-index:50; background:var(--toolbar-bg); padding:6px; border-radius:999px; border:1px solid var(--border); backdrop-filter:blur(12px); box-shadow:var(--shadow); }
.tbtn{background:var(--ui); border:1px solid var(--border); color:var(--ink); border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer; transition: all var(--transition);} .tbtn:hover{box-shadow:var(--ring); transform:scale(1.05);} .tbtn:active{transform:none}

.fragment{opacity:0; transform: translateY(8px) scale(.98); filter:saturate(.9); transition: opacity .35s var(--transition), transform .35s var(--transition), filter .35s var(--transition); transition-delay: var(--d, 0ms);} .fragment.visible{opacity:1; transform:none; filter:none}

.check{display:flex; align-items:flex-start; gap:10px}
.check input{width:20px; height:20px; margin-top:2px}
.check label{cursor:pointer}

.quiz{border:1px solid var(--border); background:#0b1526; border-radius:12px; padding:16px; margin:16px 0}
.q-title{font-weight:800; margin-bottom:12px; font-size:18px;}
.q-options{display:block; margin:8px 0}
.q-option{border:1px solid var(--border); padding:12px 16px; border-radius:10px; cursor:pointer; margin:8px 0; background:#0f172a; transition: all var(--transition); outline:0;}
.q-option:hover{box-shadow:var(--ring); transform:translateX(4px);} .q-option.selected{border-color:var(--accent); background:#60a5fa1a;}
.q-option.correct.show{background:#10b98122; border-color:#10b981;} .q-option.wrong.show{background:#ef444422; border-color:#ef4444;}
.q-actions{display:flex; gap:8px; margin-top:12px}
.q-actions .btn{padding:8px 12px; font-size:14px;}

.panel{ position:fixed; right:18px; top:88px; width:380px; max-width:calc(100vw - 36px); background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; display:none; z-index:60; }
.panel.active{display:block; animation: slideDown .25s ease}
@keyframes slideDown{from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:none}}
.panel h4{margin:0 0 12px 0}
.panel .row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0}
.panel input[type="range"]{width:140px}
.panel .input{width:200px}
.switch{display:flex; align-items:center; gap:8px}
.switch input{width:20px; height:20px}

.all-view{display:none}
.allinone .deck{display:none}
.allinone .all-view{display:block; padding:24px; max-width:1280px; margin:0 auto}
.allinone .all-view .slide{display:block; position:relative; padding:28px 56px 84px; /* +bottom pour éviter chevauchement timeline */ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:18px}
#printRoot{display:none}
.page-num{position:absolute; right:20px; bottom:14px; font-size:12px; color:var(--muted)}

@media print{
  body{background:#fff; color:#000}
  .toolbar,.panel,.grid,.bg-illus,.draw-overlay,.timer,.help,.timeline,.step-indicator{display:none !important}
  #app{display:block}
  #printRoot{display:block; padding:0; margin:0}
  #printRoot .slide{display:block; page-break-inside:avoid; background:#fff; color:#000; border:none; padding:20mm; height:auto}
  #printRoot h1,#printRoot h2,#printRoot h3,#printRoot p,#printRoot li,#printRoot table{color:#000}
}

body.theme-light{
  --bg:#f7fafc; --panel:#ffffff; --ink:#0b1220; --muted:#5b6b7f; --accent:#2563eb; --accent-2:#ea580c; --ring: 0 0 0 3px #2563eb33; --border:#e2e8f0; --ui:#f1f5f9; --img-opacity:.06; --img-blur:1px;
  --toolbar-bg:#ffffffee; --timeline-bg:#e5edf8; --timeline-active:#2563eb; --timeline-done:#ea580c;
  background:
    radial-gradient(1200px 520px at 5% -20%, #2563eb0a, transparent 60%),
    radial-gradient(900px 420px at 110% 120%, #ea580c0a, transparent 60%),
    var(--bg);
}
body.theme-light .bar-top{background: linear-gradient(180deg,#ffffff,#f7fafc);} 
body.theme-light .footer{background:#ffffff; color: var(--muted); border-top:1px solid var(--border);} 
body.theme-light thead th{ background:#f1f5f9 }
body.theme-light .title-block{background: linear-gradient(180deg,#ffffff,#f7fafc); color: var(--ink); border-left:8px solid var(--accent);} 
body.theme-light strong{ color: var(--ink); }
body.theme-light .callout{background:#f8fafc; border-left-color: var(--accent); color: var(--ink);} 
body.theme-light .grid{background:#fffd;} 
body.theme-light .thumb{background:#ffffff;} 
body.theme-light .quiz{background:#f8fafc;} 
body.theme-light .q-option{background:#ffffff;}

/* contraste supprimé en v5.2 */

.draw-overlay{ position:fixed; right:18px; bottom:88px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:6px; z-index:55; display:none; box-shadow:var(--shadow); gap:6px; align-items:center; }
.draw-overlay.active{display:flex}
.draw-canvas-wrap{position:absolute; inset:64px 0 56px 0; z-index:5; pointer-events:none}
.draw-canvas-wrap.active{pointer-events:all}
#drawCanvas{width:100%; height:100%; display:block; cursor:crosshair;}
.draw-overlay .btn{padding:6px 8px; font-size:13px;}
.draw-overlay input[type="range"]{width:80px;}

.timer{ position:fixed; right:18px; bottom:88px; background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:16px; z-index:60; display:none; min-width:280px; }
.timer.active{display:block; animation: slideUp .25s ease}
@keyframes slideUp{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}
.timer .big{font-weight:900; font-size:36px; text-align:center; margin-bottom:12px}
.timer .row{display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0}
.timer input[type="number"]{width:80px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--ui); color:var(--ink)}
.timer .presets{display:flex; gap:4px; justify-content:center;} .timer .presets button{padding:6px 8px; font-size:13px;}

.help{ position:fixed; left:18px; bottom:88px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; z-index:60; display:none; min-width:300px; }
.help.active{display:block}
.help h5{margin:0 0 8px 0; font-size:14px}
.help kbd{background:#0006; padding:.1em .4em; border-radius:6px; border:1px solid var(--border); font-size:12px}

/* Simulateur */
.sim-wrap{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:20px 0;}
.sim-wrap.single{grid-template-columns:1fr}
.net{ position:relative; background:linear-gradient(180deg, #0f172a, #0b1526); border:1px solid var(--border); border-radius:16px; height:420px; box-shadow:var(--shadow); }
.net .label{position:absolute; top:12px; left:16px; font-weight:800; color:var(--accent); background:var(--ui); padding:4px 8px; border-radius:6px; border:1px solid var(--border); font-size:11px;}
.host{ position:absolute; width:72px; height:72px; border-radius:14px; background:linear-gradient(180deg, var(--ui), #0b1220); border:1px solid var(--border); display:grid; place-items:center; font-weight:700; transition: all var(--transition); cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.3); } 
.host:hover{transform:translateY(-2px); box-shadow:var(--ring);} 
.host.active{box-shadow:0 0 0 3px var(--accent), 0 8px 24px rgba(0,0,0,.45)}
.host.pos-tl { left: 10%; top: 15%; }
.host.pos-tr { right: 10%; top: 15%; }
.host.pos-bl { left: 10%; bottom: 15%; }
.host.pos-br { right: 10%; bottom: 15%; }
.device{ position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); width:110px; height:64px; border-radius:14px; background:linear-gradient(180deg, #0ea5e9, #0284c7); border:2px solid #075985; color:white; display:grid; place-items:center; font-weight:800; text-transform:uppercase; letter-spacing:.5px; box-shadow:0 6px 16px rgba(0,0,0,.4); } 
.device.switch{ background:linear-gradient(180deg, #10b981, #059669); border-color:#065f46; }
.device.active{filter:brightness(1.2);} 
.link{position:absolute; height:3px; background:linear-gradient(90deg, var(--border), var(--muted)); transform-origin:left center; border-radius:2px; z-index:1;}
.pulse{position:absolute; width:12px; height:12px; border-radius:50%; background:var(--accent); box-shadow:0 0 20px var(--accent); animation: pulse 1.2s ease-out; z-index:10;}
@keyframes pulse{from{opacity:1; transform:scale(1)} to{opacity:0; transform:scale(2)}}
.collision{position:absolute; inset:0; display:grid; place-items:center; font-weight:900; color:#fff; background:radial-gradient(circle at 50% 50%, #ef444488, transparent 50%); opacity:0; transition: opacity .2s; font-size:24px; text-shadow:2px 2px 4px rgba(0,0,0,.8);} .collision.show{opacity:1; animation: flash .5s ease;} @keyframes flash{0%,100%{opacity:0} 50%{opacity:1}}
.macbox{position:absolute; right:12px; bottom:12px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:12px; color:var(--ink); box-shadow:var(--shadow);} 
.macbox .title{font-weight:800; margin-bottom:6px; color:var(--accent);} 
.macbox table{font-size:11px; margin:6px 0 0; min-width:140px;} .macbox th,.macbox td{padding:4px 6px; font-weight:600;} .macbox th{color:var(--muted);} 
.macbox tr.new{outline:2px solid var(--accent); outline-offset:2px; animation: fadeNew 1.4s ease forwards}
@keyframes fadeNew{0%{outline-color:var(--accent)} 100%{outline-color:transparent}}

.mini-timer{display:inline-flex; align-items:center; gap:.4rem; font-variant-numeric:tabular-nums; font-weight:800; color:var(--accent); background:var(--ui); border:1px solid var(--border); border-radius:999px; padding:.25rem .6rem}
[hidden]{display:none !important}

.step-indicator{ position:fixed; left:50%; transform:translateX(-50%); bottom:72px; display:none; gap:.35rem; z-index:45; background:var(--toolbar-bg); border:1px solid var(--border); border-radius:999px; padding:.3rem .6rem; }
.step-indicator .dot{ width:8px; height:8px; border-radius:999px; background:var(--timeline-bg); }
.step-indicator .dot.active{ background:var(--accent); }

.domain{position:absolute; inset:10px; border:2px dashed var(--muted); border-radius:16px; color:var(--muted); font-weight:800; display:flex; align-items:flex-end; padding:8px; pointer-events:none}
.seg-badge{position:absolute; top:10px; right:10px; background:var(--ui); border:1px solid var(--border); color:var(--muted); font-weight:800; font-size:11px; padding:4px 8px; border-radius:999px}
.gauge{position:relative; height:12px; background:var(--timeline-bg); border:1px solid var(--border); border-radius:999px; overflow:hidden;}
.gauge .gfill{height:100%; width:0%; background:linear-gradient(90deg, var(--danger), var(--accent-2)); transition:width .4s ease}
.gauge .gtext{position:absolute; top:-22px; right:0; font-size:11px; color:var(--muted); font-weight:800}
.legend{display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:12px; color:var(--muted);} .legend .dot{width:10px; height:10px; border-radius:999px; display:inline-block} .legend .d1{background:var(--accent-2)} .legend .d2{background:var(--accent)} .legend .d3{background:var(--ok)}

.sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
:focus-visible{ outline: var(--ring); outline-offset: 2px; }

/* === v6 UX/Animation upgrades =============================================
   - Transitions sélectionnables (fade / slide / zoom)
   - Animations de fragments (fade / rise / right / scale) + décalage auto
   - Effet Ken Burns léger sur l'arrière-plan (désactivé si RRM)
   - Projecteur (spotlight) au clavier (L) pour guider l'attention
   - Barre d'outils auto-atténuée en inactivité (desktop)
============================================================================= */
:root{
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
}
/* Transitions de diapo (surchargent la règle par défaut) */
body[data-trans="fade"] .slide.active{ animation: fadeIn .36s var(--ease) }
body[data-trans="slide"] .slide.active{ animation: slideIn .36s var(--ease) }
body[data-trans="zoom"] .slide.active{ animation: zoomIn .42s var(--ease) }

@keyframes fadeIn{ from{opacity:0} to{opacity:1} }
@keyframes zoomIn{ from{opacity:0; transform:scale(.985)} to{opacity:1; transform:none} }

/* Fragments — variantes */
.fragment{ will-change: opacity, transform; }
.fragment.visible[data-anim="fade"]{ animation: fFade .44s var(--ease) both; animation-delay: var(--d, 0ms); }
.fragment.visible[data-anim="rise"]{ animation: fRise .44s var(--ease) both; animation-delay: var(--d, 0ms); }
.fragment.visible[data-anim="right"]{ animation: fRight .44s var(--ease) both; animation-delay: var(--d, 0ms); }
.fragment.visible[data-anim="scale"]{ animation: fScale .44s var(--ease) both; animation-delay: var(--d, 0ms); }

@keyframes fFade{ from{opacity:0} to{opacity:1} }
@keyframes fRise{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
@keyframes fRight{ from{opacity:0; transform:translateX(10px)} to{opacity:1; transform:none} }
@keyframes fScale{ from{opacity:0; transform:scale(.985)} to{opacity:1; transform:none} }

/* Ken Burns très léger sur l'image de fond */
.bg-illus{ animation: kenburns 60s ease-in-out infinite alternate; transform-origin: center; }
@keyframes kenburns{ from{ transform: scale(1) translate(0,0) } to{ transform: scale(1.08) translate(-1.5%, -1.5%) } }

/* Spotlight (projecteur) */
.spotlight{ position:fixed; inset:0; pointer-events:none; display:none; z-index:120;
  background: radial-gradient(160px 160px at var(--x,50%) var(--y,50%), transparent 0%, rgba(0,0,0,.62) 65%);
}
.spotlight.on{ display:block; animation: fadeIn .18s var(--ease) }

/* Barre d'outils — atténuation quand idle (souris immobile) */
.toolbar{ transition: opacity .35s var(--ease), transform .35s var(--ease); }
.toolbar.idle{ opacity:.22; transform: translateY(6px); }

@media (pointer:coarse){
  .toolbar{ bottom:10px }
  .tbtn{ padding:10px 14px; }
}

@media (prefers-reduced-motion: reduce){
  .bg-illus{ animation: none !important; transform:none !important }
  .spotlight.on{ animation: none !important }
}

</style></style>
</head>
<body>
<a class="sr-only" href="#viewport">Aller au contenu</a>
<div id="app" aria-describedby="live">
  <div class="deck-wrap">
    <div class="deck" id="deck" role="region" aria-label="Diaporama interactif">
      <div class="bar-top">
        <div class="brand">
          <div class="logo"><span class="icon">🌐</span><span>Hub vs Switch</span></div>
          <div class="sub">Bac Pro CIEL — Séance S1</div>
        </div>
        <div class="meta">
          <div class="badge"><span id="title">Réseaux L1/L2</span></div>
          <div class="badge" id="modeBadge">Mode <span id="modeDisplay">Pas à pas</span></div>
          <div class="badge" id="scoreBadge">Score <span id="score">—</span></div>
          <span id="miniTimer" class="mini-timer" hidden title="Cliquer pour ouvrir le minuteur" role="status" aria-live="polite">⏱ 00:00</span>
          <input class="input" id="studentName" placeholder="Nom élève (optionnel)" aria-label="Nom de l'élève"/>
        </div>
        <div class="controls">
          <button class="btn" id="themeBtn" aria-label="Changer de thème" title="Thème (Sombre/Clair)">🎨 Thème</button>
          <button class="btn" id="modeBtn" aria-label="Changer le mode d'affichage" title="Basculer Pas à pas / Complet / Auto">🎬 Mode</button>
          <button class="btn" id="settingsBtn" aria-expanded="false" aria-controls="panel" title="Réglages">⚙️ Réglages</button>
          <button class="btn" id="allBtn" aria-pressed="false" title="Affichage 'Tout' (impression)">📄 Tout afficher</button>
        </div>
      </div>

      <div class="content">
        <div class="bg-illus" id="bg" aria-hidden="true"></div>
        <div class="slide-viewport" id="viewport" role="group" aria-label="Zone de diapo"></div>
        <div class="grid" id="grid" aria-hidden="true"><div class="grid-inner" id="grid-inner"></div></div>
        <div class="draw-canvas-wrap" id="drawWrap"><canvas id="drawCanvas"></canvas></div>
      </div>

      <div class="footer">
        <div>
          ←/→ naviguer · G grille · F plein écran · P PDF · T minuteur · D annoter · ? aide · Espace suivant · ESC fermer
        </div>
        <div class="counter" id="counter" aria-live="polite">1 / 1</div>
      </div>
      <div class="progressbar"><div class="progress" id="progress"></div></div>
      <div class="timeline" id="timeline" aria-label="Timeline de progression"></div>
    </div>
  </div>

  <div class="step-indicator" id="stepIndicator" aria-hidden="true"></div>

  <div class="toolbar" role="toolbar" aria-label="Barre d'actions">
    <button class="tbtn" id="prevBtn" title="Précédent (←)">◀</button>
    <button class="tbtn" id="nextBtn" title="Suivant (→)">▶</button>
    <button class="tbtn" id="gridBtn" title="Grille (G) — Aperçu des diapos">⊞</button>
    <button class="tbtn" id="fullscreenBtn" title="Plein écran (F)">⛶</button>
    <button class="tbtn" id="timerBtn" title="Minuteur (T)">⏱</button>
    <button class="tbtn" id="drawBtn" title="Annoter (D) — crayon/gomme">✏️</button>
    <button class="tbtn" id="pdfBtn" title="Imprimer / Export PDF (P)">📄</button>
    <button class="tbtn" id="exportBtn" title="Exporter le score (CSV/JSON) — icône barres">📊</button>
    <button class="tbtn" id="resetBtn" title="Réinitialiser la session (RAZ) — icône recyclage">♻︎</button>
  </div>

  <div class="panel" id="panel" role="dialog" aria-modal="false" aria-label="Réglages">
    <h4>⚙️ Réglages</h4>
    <div class="row"><span>Mode actuel :</span><strong id="modeLabel2"></strong></div>
    <div class="row"><span>Auto‑avance :</span><input id="speed" type="range" min="2" max="10" step="1" value="3"/><span id="speedVal">3s</span></div>
    <div class="row switch"><input id="imgToggle" type="checkbox" checked/><label for="imgToggle">Images d'arrière‑plan</label></div>
    <div class="row switch"><input id="showCorr" type="checkbox" checked/><label for="showCorr">Afficher corrections quiz</label></div>
    <div class="row switch"><input id="showScore" type="checkbox" checked/><label for="showScore">Afficher score</label></div>
    <div class="row switch"><input id="showStudent" type="checkbox" checked/><label for="showStudent">Afficher champ élève</label></div>
    <div class="row switch"><input id="studentMode" type="checkbox"/><label for="studentMode">Mode élève (masquer 📄/📊/♻︎)</label></div>
    <div class="row"><span>Élève :</span><input id="studentPanel" class="input" placeholder="Nom élève"/></div>
    <div class="row"><small id="img-credit"></small></div>
  </div>

  <div class="timer" id="timer" role="dialog" aria-modal="false" aria-live="polite" aria-label="Minuteur">
    <div class="big" id="timerDisplay">00:00</div>
    <div class="row">
      <input type="number" id="minInput" min="0" max="99" value="5" aria-label="minutes">
      <span>:</span>
      <input type="number" id="secInput" min="0" max="59" value="0" aria-label="secondes">
    </div>
    <div class="presets">
      <button class="btn" data-preset="120">2min</button>
      <button class="btn" data-preset="300">5min</button>
      <button class="btn" data-preset="600">10min</button>
    </div>
    <div class="row">
      <button class="btn" id="startTimer">▶ Start</button>
      <button class="btn" id="pauseTimer">⏸ Pause</button>
      <button class="btn" id="resetTimer">⟲ Reset</button>
    </div>
  </div>

  <div class="help" id="help" role="dialog" aria-modal="false" aria-label="Aide clavier">
    <h5>Raccourcis</h5>
    <div><kbd>←</kbd>/<kbd>→</kbd> navigation · <kbd>Espace</kbd> suivant</div>
    <div><kbd>G</kbd> grille · <kbd>F</kbd> plein écran · <kbd>P</kbd> PDF</div>
    <div><kbd>T</kbd> minuteur · <kbd>D</kbd> annoter · <kbd>?</kbd> aide</div>
    <div>Quiz : <kbd>1–9</kbd> sélection · <kbd>Entrée</kbd>/<kbd>Espace</kbd> valider</div>
    <div><kbd>ESC</kbd> ferme panneaux</div>
  </div>

  <div class="draw-overlay" id="drawOverlay" aria-label="Outils d'annotation">
    <button class="btn" id="penClear" title="Effacer">🧽</button>
    <input id="penSize" type="range" min="2" max="12" value="3" title="Épaisseur"/>
    <input id="penColor" type="color" value="#60a5fa" title="Couleur"/>
    <button class="btn" id="penSave" title="Sauvegarder">💾</button>
  </div>

  <div class="lightbox" id="lightbox">
    <img id="lightboxImg" src="" alt="">
    <div class="lightbox-caption" id="lightboxCaption"></div>
  </div>

  <div id="printRoot"></div>
</div>

<div id="live" class="sr-only" aria-live="polite"></div>

<script id="md" type="text/plain"># 🚀 HUB vs SWITCH - Comprendre les fondamentaux

---

## 📊 Constats du TP Packet Tracer

@img[https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=800|Équipements réseau en rack|medium|float-right]

**Ce que vous avez observé :**

**Avec le Hub :**
- Trafic répliqué sur **tous** les ports
- **Collisions** fréquentes (CSMA/CD, half‑duplex)
- Débit **partagé** qui chute

**Avec le Switch :**
- Trames vers le port **ciblé** uniquement (unicast)
- **Table MAC** apprise automatiquement
- Performances **stables** (full‑duplex)

---

## 🔍 Où ça se passe dans l'OSI ?

| Équipement | Couche OSI | Fonction |
|------------|------------|----------|
| **Hub** | 1 - Physique | Répéteur multi-ports |
| **Switch** | 2 - Liaison | Commutation MAC |

**Conséquence :** Le hub = **1 domaine de collision**. Le switch = **1 domaine par port**.

@img[https://images.unsplash.com/photo-1516044734145-07ca8eef8731?w=600|Modèle OSI - Couches réseau|full]

---

## 🧪 Mini-simulateur — Hub (démo alignée)

<div class="sim-wrap single">
  <div class="net" id="netHub">
    <div class="label">Hub</div>
    <div class="device">HUB</div>
    <div class="domain">Domaine de collision unique</div>
    <div class="host pos-tl" id="hA">A</div>
    <div class="host pos-tr" id="hB">B</div>
    <div class="host pos-bl" id="hC">C</div>
    <div class="host pos-br" id="hD">D</div>
    <div class="collision" id="colHub">💥 COLLISION</div>
    <div class="seg-badge">Half‑duplex</div>
  </div>
</div>

**Contrôles :**
<div style="display:flex; gap:8px; margin:12px 0; flex-wrap:wrap">
<button class="btn" onclick="simHub()">🔄 A→B (broadcast)</button>
<button class="btn" onclick="simHubCD()">🔄 C→D (broadcast)</button>
<button class="btn" onclick="simHubCollision()">💥 A & C simultanés (collision)</button>
<button class="btn" onclick="resetSim()">♻️ Réinitialiser</button>
</div>

<div class="legend" style="margin:8px 0 6px"><span class="dot d1"></span> Diffusion/broadcast · <span class="dot d2"></span> Trame émise</div>
<div class="gauge" style="margin:6px 0 0; max-width:520px" aria-label="Charge réseau (Hub)">
  <div class="gfill" id="hubFill"></div>
  <div class="gtext"><span id="hubPct">0%</span> charge</div>
</div>

---

## 🧪 Mini-simulateur — Switch (démo alignée)

<div class="sim-wrap single">
  <div class="net" id="netSw">
    <div class="label">Switch</div>
    <div class="device switch">SWITCH</div>
    <div class="host pos-tl" id="sA">A</div>
    <div class="host pos-tr" id="sB">B</div>
    <div class="host pos-bl" id="sC">C</div>
    <div class="host pos-br" id="sD">D</div>
    <div class="macbox" id="macBox">
      <div class="title">📋 Table MAC</div>
      <table><thead><tr><th>Adresse MAC</th><th>Port</th></tr></thead><tbody id="macBody"></tbody></table>
    </div>
    <div class="seg-badge" style="right:auto; left:10px">Full‑duplex · Micro‑segmentation</div>
  </div>
</div>

**Contrôles :**
<div style="display:flex; gap:8px; margin:12px 0; flex-wrap:wrap">
<button class="btn" onclick="simSwitch()">🎯 A→B (learn & unicast)</button>
<button class="btn" onclick="simSwitchCA()">🎯 C→A (unicast)</button>
<button class="btn" onclick="simSwitchBroadcast()">📡 A→Broadcast (flood)</button>
<button class="btn" onclick="resetSim()">♻️ Réinitialiser</button>
</div>

<div class="legend" style="margin:8px 0 6px"><span class="dot d2"></span> Unicast ciblé · <span class="dot d1"></span> Flood si destination inconnue · <span class="dot d3"></span> Entrée MAC nouvellement apprise</div>

---

## 📚 Analyse détaillée avec illustrations

### 🔄 Hub - Comportement observé

@gallery[
https://images.unsplash.com/photo-1544197150-b99a580bb7a8?w=400|Hub Ethernet classique
https://images.unsplash.com/photo-1517077304055-6e89abbf09b0?w=400|Domaine de collision
https://images.unsplash.com/photo-1606765962248-7ff407b51667?w=400|Trafic broadcast
]

- **Diffusion systématique :** Toutes les trames sont dupliquées sur tous les ports
- **Domaine de collision unique :** Tous les équipements partagent le même domaine
- **Half-duplex forcé :** Impossible d'émettre et recevoir simultanément
- **Pas d'apprentissage :** Simple répéteur

### 🎯 Switch - Comportement intelligent  

@img[https://images.unsplash.com/photo-1517180102446-f3ece451e9d8?w=600|Switch manageable 24 ports|large]

- **Apprentissage MAC :** Construction automatique de la table d'adresses
- **Unicast ciblé :** Envoi direct vers le bon port (si connu)
- **Flooding contrôlé :** Diffusion uniquement si destination inconnue
- **Isolation des domaines :** Chaque port = 1 domaine de collision

> **💡 Point clé :** Le switch **apprend** les adresses MAC au fil du trafic.

---

## ❓ Quiz 1 : Couche OSI

**À quelle couche OSI fonctionne un hub ?**

- (x) Couche 2 (Liaison)
- (✓) Couche 1 (Physique)
- (x) Couche 3 (Réseau)

---

## ❓ Quiz 2 : Décision de commutation

**Comment un switch décide où envoyer une trame ?**

- (✓) Via sa table MAC
- (x) Par l'adresse IP
- (x) En diffusant partout

---

## 🔒 Aspect Sécurité

@img[https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?w=500|Sécurité réseau|small|float-left]

**Hub = Risque**
- Sniffing trivial (tout est diffusé)
- Aucune isolation

**Switch = Protection basique**
- Communication point‑à‑point, isolation par port
- ⚠️ Reste : ARP spoofing / usurpation MAC  
  _Mitigations :_ port‑security, DHCP Snooping, DAI

---

## 📈 Impact Performance (ordres de grandeur)

| Métrique | Hub | Switch |
|----------|-----|--------|
| **Débit** | 10 Mb/s **partagés** (typique) | **par port** (100 Mb/s, 1 Gb/s, …) |
| **Duplex** | Half‑duplex | Full‑duplex |
| **Collisions** | Possibles | **0 %** |
| **Latence de traversée** | ~0,1–1 µs (répéteur) + backoff | ~3–10 µs (store‑and‑forward) |

@img[https://images.unsplash.com/photo-1551703599-6b3e8379aa8c?w=800|Graphique de performance réseau|full]

---

## ✅ Check‑list des compétences

- [x] Distinguer Hub (L1) vs Switch (L2)
- [x] Comprendre les domaines de collision
- [x] Analyser une table MAC
- [ ] Configurer un VLAN (prochaine séance)

---

## 🎯 Conclusion

> **À retenir :** Le switch élimine les collisions par **micro‑segmentation** et **full‑duplex**.

**Compétence validée :** C04 (N1) - Analyse des flux réseau

**Prochaine séance :** Câblage RJ45 & normes TIA‑568

@img[https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=600|Atelier réseau|medium]

---

## 🖼️ Schéma vectoriel final

<div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:center">
  <svg viewBox="0 0 520 320" role="img" aria-label="Schéma hub (broadcast)">
    <defs>
      <linearGradient id="gHub" x1="0" x2="1"><stop offset="0" stop-color="#f59e0b"/><stop offset="1" stop-color="#ef4444"/></linearGradient>
      <marker id="arrowHub" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#f59e0b"/></marker>
    </defs>
    <rect x="0" y="0" width="520" height="320" rx="14" fill="none" stroke="var(--border)"/>
    <text x="16" y="26" fill="var(--muted)" font-weight="800">HUB — Broadcast & collisions</text>
    <rect x="210" y="130" width="100" height="42" rx="8" fill="#0ea5e9" stroke="#075985"/>
    <text x="260" y="157" text-anchor="middle" fill="#fff" font-weight="800">HUB</text>
    <g fill="var(--ui)" stroke="var(--border)">
      <rect x="50" y="40" width="60" height="40" rx="8"/>
      <rect x="410" y="40" width="60" height="40" rx="8"/>
      <rect x="50" y="240" width="60" height="40" rx="8"/>
      <rect x="410" y="240" width="60" height="40" rx="8"/>
    </g>
    <text x="80" y="68" text-anchor="middle">A</text>
    <text x="440" y="68" text-anchor="middle">B</text>
    <text x="80" y="268" text-anchor="middle">C</text>
    <text x="440" y="268" text-anchor="middle">D</text>
    <g stroke="var(--muted)" stroke-width="3">
      <line x1="110" y1="60" x2="210" y2="151"/>
      <line x1="410" y1="60" x2="310" y2="151"/>
      <line x1="110" y1="260" x2="210" y2="151"/>
      <line x1="410" y1="260" x2="310" y2="151"/>
    </g>
    <g stroke="url(#gHub)" stroke-width="4" marker-end="url(#arrowHub)">
      <line x1="110" y1="60" x2="210" y2="151"/>
      <line x1="210" y1="151" x2="410" y2="60"/>
      <line x1="210" y1="151" x2="110" y2="260"/>
      <line x1="210" y1="151" x2="410" y2="260"/>
    </g>
    <rect x="12" y="34" width="496" height="272" rx="12" fill="none" stroke-dasharray="8 6" stroke="#9aa4b2"/>
    <text x="26" y="304" fill="var(--muted)" font-size="12" font-weight="800">Domaine de collision unique</text>
  </svg>
  <svg viewBox="0 0 520 320" role="img" aria-label="Schéma switch (unicast)">
    <defs>
      <linearGradient id="gSw" x1="0" x2="1"><stop offset="0" stop-color="#10b981"/><stop offset="1" stop-color="#059669"/></linearGradient>
      <marker id="arrowSw" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" fill="#10b981"/></marker>
    </defs>
    <rect x="0" y="0" width="520" height="320" rx="14" fill="none" stroke="var(--border)"/>
    <text x="16" y="26" fill="var(--muted)" font-weight="800">SWITCH — Unicast & micro‑segmentation</text>
    <rect x="210" y="130" width="100" height="42" rx="8" fill="#10b981" stroke="#065f46"/>
    <text x="260" y="157" text-anchor="middle" fill="#fff" font-weight="800">SWITCH</text>
    <g fill="var(--ui)" stroke="var(--border)">
      <rect x="50" y="40" width="60" height="40" rx="8"/>
      <rect x="410" y="40" width="60" height="40" rx="8"/>
      <rect x="50" y="240" width="60" height="40" rx="8"/>
      <rect x="410" y="240" width="60" height="40" rx="8"/>
    </g>
    <text x="80" y="68" text-anchor="middle">A</text>
    <text x="440" y="68" text-anchor="middle">B</text>
    <text x="80" y="268" text-anchor="middle">C</text>
    <text x="440" y="268" text-anchor="middle">D</text>
    <g stroke="var(--muted)" stroke-width="3">
      <line x1="110" y1="60" x2="210" y2="151"/>
      <line x1="410" y1="60" x2="310" y2="151"/>
      <line x1="110" y1="260" x2="210" y2="151"/>
      <line x1="410" y1="260" x2="310" y2="151"/>
    </g>
    <g stroke="url(#gSw)" stroke-width="4" marker-end="url(#arrowSw)">
      <line x1="110" y1="60" x2="210" y2="151"/>
      <line x1="210" y1="151" x2="410" y2="60"/>
    </g>
    <circle cx="110" cy="60" r="38" fill="none" stroke="#10b981" stroke-dasharray="6 6"/>
    <circle cx="410" cy="60" r="38" fill="none" stroke="#10b981" stroke-dasharray="6 6"/>
    <circle cx="110" cy="260" r="38" fill="none" stroke="#10b981" stroke-dasharray="6 6"/>
    <circle cx="410" cy="260" r="38" fill="none" stroke="#10b981" stroke-dasharray="6 6"/>
  </svg>
</div>

</script>

<script>
/* ====== Helpers & images ====== */
const safeStore = { get(k){ try{return localStorage.getItem(k)}catch(e){return null} }, set(k,v){ try{localStorage.setItem(k,v)}catch(e){} }, del(k){ try{localStorage.removeItem(k)}catch(e){} } };
const IMG_MANIFEST = [
  {"src":"https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=1200","title":"Infrastructure réseau","credit":"Unsplash"},
  {"src":"https://images.unsplash.com/photo-1516044734145-07ca8eef8731?w=1200","title":"Switches et câbles","credit":"Unsplash"},
  {"src":"https://images.unsplash.com/photo-1517180102446-f3ece451e9d8?w=1200","title":"Data center","credit":"Unsplash"}
];
IMG_MANIFEST.forEach(i=>{ const l=new Image(); l.decoding='async'; l.src=i.src; });

function parseMarkdown(md){ md = md.replace(/\r/g,''); const pieces = md.split(/\n-{3,}\n/g); return pieces.map(blockToHtml); }
function mdEscape(s){ return s.replace(/[&<>]/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch])); }
function mdInline(s){
  return s
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`([^`]+?)`/g,'<code class="kbd">$1</code>')
    .replace(/\[([^\]]+?)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
}
function blockToHtml(block){
  const lines = block.split('\n'); let i=0, html=''; let lastH='Question';
  function peekList(regex){ const out=[]; let j=i; while(j<lines.length && regex.test(lines[j])){ out.push(lines[j]); j++; } return out; }
  function consumeList(regex, tag){
    const preview = peekList(regex);
    const isQuiz = preview.some(l => /^\s*[-*]\s*\((?:✓|x|X)\)\s+/.test(l));
    if(isQuiz){
      let items=[]; let correctCount=0;
      while(i<lines.length && regex.test(lines[i])){
        const raw = lines[i];
        const m = raw.match(/^\s*[-*]\s*\((✓|x|X)\)\s+(.*)$/);
        if(m){ const ok = m[1]==='✓'; if(ok) correctCount++; items.push({html: mdInline(m[2].trim()), ok}); i++; }
        else{ const txt = raw.replace(regex,'').trim(); items.push({html: mdInline(txt), ok:null}); i++; }
      }
      const mode = correctCount>1 ? 'multi' : 'single';
      let out = `<div class="quiz" data-mode="${mode}" role="group" aria-label="Question à choix" aria-live="off"><div class="q-title">${mdEscape(lastH)}</div><div class="q-options" role="listbox" ${mode==='multi'?'aria-multiselectable="true"':''}>`;
      items.forEach((it,idx)=>{ const cls = it.ok===true?'correct':(it.ok===false?'wrong':'neutral'); out += `<div class="q-option ${cls}" data-idx="${idx}" role="option" aria-selected="false" tabindex="0">${it.html}</div>`; });
      out += `</div><div class="q-actions"><button class="btn q-check">Vérifier</button><button class="btn q-reset">Réinitialiser</button></div></div>`; return out;
    }
    let out = `<${tag}>`;
    while(i<lines.length && regex.test(lines[i])){
      const raw = lines[i];
      const mcb = raw.match(/^\s*[-*]\s+\[( |x|X)\]\s+(.*)$/);
      if(mcb){ const checked = /x/i.test(mcb[1]); const text = mdInline(mcb[2].trim()); out += `<li class="check fragment"><input type="checkbox" ${checked?'checked':''}><label>${text}</label></li>`; i++; continue; }
      const item = raw.replace(regex, ''); out += `<li class="fragment">${mdInline(item.trim())}</li>`; i++;
    }
    out += `</${tag}>`; return out;
  }
  function consumeTable(){
    let rows=[]; while(i<lines.length && /^\|.*\|$/.test(lines[i].trim())){ rows.push(lines[i].trim()); i++; }
    if(rows.length<2) return '';
    const header = rows[0].slice(1,-1).split('|').map(s=>s.trim());
    const bodyRows = rows.slice(1).filter(r=>!/^-+\|/.test(r));
    const tbody = bodyRows.map(r => r.slice(1,-1).split('|').map(s=>s.trim()));
    let out = '<table><thead><tr>'; header.forEach(h => out += `<th>${mdInline(h)}</th>`); out += '</tr></thead><tbody>';
    tbody.forEach(cols => { out += '<tr>' + cols.map(c=>`<td>${mdInline(c)}</td>`).join('') + '</tr>'; }); out += '</tbody></table>'; return out;
  }
  while(i<lines.length){
    let line = lines[i]; if(line.trim()===''){ i++; continue; }
    if(/^#{1,3}\s/.test(line)){ const level = (line.match(/^#+/)[0] || '#').length; const content = line.replace(/^#{1,6}\s/, ''); lastH = content; html += `<h${Math.min(level,3)}>${mdInline(content)}</h${Math.min(level,3)}>`; i++; continue; }
    if(/^\s*[-*]\s+/.test(line)){ html += consumeList(/^\s*[-*]\s+/, 'ul'); continue; }
    if(/^\s*\d+\.\s+/.test(line)){ html += consumeList(/^\s*\d+\.\s+/, 'ol'); continue; }
    if(/^\s*\|.*\|$/.test(line.trim())){ html += consumeTable(); continue; }
    if(/^\s*>\s?/.test(line)){ html += `<div class="callout">${mdInline(line.replace(/^\s*>\s?/, ''))}</div>`; i++; continue; }
    if(/^\s*@img\[/.test(line)){
      const m = line.match(/^\s*@img\[([^|\]]+)(?:\|([^|\]]+))?(?:\|([^|\]]+))?(?:\|([^|\]]+))?\]/);
      if(m){ const url=m[1]; const caption=m[2]||''; const size=m[3]||'medium'; const position=m[4]||''; let classStr='img-inline '+size; if(position.includes('float-left')) classStr='img-inline img-float-left '+size; if(position.includes('float-right')) classStr='img-inline img-float-right '+size; if(caption){ html += `<div class="img-figure"><img src="${url}" alt="${mdEscape(caption)}" class="${classStr}" onclick="openLightbox('${url}','${mdEscape(caption)}')" loading="lazy"><figcaption>${mdEscape(caption)}</figcaption></div>`; } else { html += `<img src="${url}" alt="Image" class="${classStr}" onclick="openLightbox('${url}','')" loading="lazy">`; } i++; continue; }
    }
    if(/^\s*@gallery\[/.test(line)){
      // Supporte : bloc multi‑lignes
      //   @gallery[
      //   url|légende
      //   url2|légende2
      //   ]
      // et la variante inline : @gallery[url|cap;url2|cap2]
      let items = [];
      const inline = line.match(/^\s*@gallery\[(.*)\]\s*$/);
      if(inline){
        items = inline[1].split(/\s*;\s*|\n/).map(s=>s.trim()).filter(Boolean);
        i++;
      } else {
        i++; // passer après "@gallery["
        while(i<lines.length && !/^\s*\]\s*$/.test(lines[i])){
          const s = lines[i].trim();
          if(s) items.push(s);
          i++;
        }
        if(i<lines.length && /^\s*\]\s*$/.test(lines[i])) i++; // consommer la fermeture
      }
      if(items.length){
        html += '<div class="img-gallery">';
        items.forEach(item=>{
          const parts=item.split('|');
          const url=(parts[0]||'').trim();
          const caption=(parts[1]||'').trim();
          html += `<img src="${url}" alt="${mdEscape(caption)}" title="${mdEscape(caption)}" onclick="openLightbox('${url}','${mdEscape(caption)}')" loading="lazy">`;
        });
        html += '</div>';
      }
      continue;
    }
    if(/^\s*!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/.test(line)){
      const m = line.match(/^\s*!\[([^\]]*)\]\((https?:\/\/[^\s)]+)\)/); html += `<figure><img src="${m[2]}" alt="${mdEscape(m[1]||'Illustration')}" onclick="openLightbox('${m[2]}','${mdEscape(m[1]||'')}')" loading="lazy" style="cursor:zoom-in"><figcaption>${mdEscape(m[1]||'')}</figcaption></figure>`; i++; continue;
    }
    if(/^\s*</.test(line)){ html += line; i++; continue; }
    html += `<p class="fragment">${mdInline(line)}</p>`; i++;
  }
  return html;
}
function openLightbox(url, caption){ const lb=document.getElementById('lightbox'); const img=document.getElementById('lightboxImg'); const cap=document.getElementById('lightboxCaption'); img.src=url; cap.textContent=caption; cap.style.display = caption ? 'block' : 'none'; lb.classList.add('active'); }
function closeLightbox(){ document.getElementById('lightbox').classList.remove('active'); }
document.addEventListener('DOMContentLoaded', ()=>{ const lb=document.getElementById('lightbox'); lb.addEventListener('click', closeLightbox); document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && lb.classList.contains('active')) closeLightbox(); }); });

/* ===== Liens du simulateur ===== */
const linkRegistry = [];
function positionLink(el, a, b){ const nr = el.parentElement.getBoundingClientRect(); const ar = a.getBoundingClientRect(), br = b.getBoundingClientRect(); const ax = ar.left + ar.width/2 - nr.left, ay = ar.top + ar.height/2 - nr.top; const bx = br.left + br.width/2 - nr.left, by = br.top + br.height/2 - nr.top; const dx = bx-ax, dy=by-ay; const len = Math.hypot(dx,dy); const angle=Math.atan2(dy,dx)*180/Math.PI; el.style.width = len+'px'; el.style.left=ax+'px'; el.style.top=ay+'px'; el.style.transform=`rotate(${angle}deg)`; }
function setupLinks(netId, deviceSel, hostIds){ const net=document.getElementById(netId); if(!net) return; const device=net.querySelector(deviceSel); hostIds.forEach(id=>{ const host=document.getElementById(id); if(!host) return; const link=document.createElement('div'); link.className='link'; net.appendChild(link); positionLink(link, host, device); linkRegistry.push({el:link, a:host, b:device}); }); }
function positionAllLinks(){ linkRegistry.forEach(L=> positionLink(L.el, L.a, L.b)); }
let linksSetup=false; function setupLinksIfAny(){ if(linksSetup) return; const hub=document.getElementById('netHub'), sw=document.getElementById('netSw'); if(hub && sw){ setupLinks('netHub', '.device', ['hA','hB','hC','hD']); setupLinks('netSw', '.device.switch', ['sA','sB','sC','sD']); linksSetup=true; } }

(function selftests(){ try{ console.assert(Array.isArray(linkRegistry), 'linkRegistry doit être un tableau'); }catch(e){} try{ positionAllLinks(); }catch(e){} })();

window.addEventListener('load', positionAllLinks);
if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=> positionAllLinks()); }
</script>

<script>
(function(){
  const deck=document.getElementById('deck');
  const grid=document.getElementById('grid');
  const gridInner=document.getElementById('grid-inner');
  const progress=document.getElementById('progress');
  const counter=document.getElementById('counter');
  const titleEl=document.getElementById('title');
  const scoreEl=document.getElementById('score');
  const scoreBadge=document.getElementById('scoreBadge');
  const studentField=document.getElementById('studentName');
  const live=document.getElementById('live');
  const help=document.getElementById('help');
  const miniTimerChip=document.getElementById('miniTimer');
  const timeline=document.getElementById('timeline');
  const stepIndicator=document.getElementById('stepIndicator');
  const viewport=document.getElementById('viewport');

  const raw=document.getElementById('md').textContent;
  const slidesHtml=parseMarkdown(raw);
  const slides=[];

  slidesHtml.forEach((html, idx)=>{ const s=document.createElement('section'); s.className='slide'; if(idx===0){ const h1m=html.match(/<h1>([\s\S]*?)<\/h1>/); const h1=h1m? h1m[1] : 'Séance'; const rest=h1m? html.replace(/^<h1>[\s\S]*?<\/h1>/,'') : html; s.innerHTML = `<div class="title-block"><h1>${h1}</h1></div>${rest}`; titleEl.textContent = h1.replace(/<[^>]+>/g,'').substring(0,20); } else { s.innerHTML = html; } viewport.appendChild(s); slides.push(s); });

  const bg=document.getElementById('bg'); const credit=document.getElementById('img-credit');
  function setBgForSlide(i){ if(!IMG_MANIFEST.length) return; const item=IMG_MANIFEST[i % IMG_MANIFEST.length]; bg.style.backgroundImage=`url('${item.src}')`; if(credit) credit.textContent = `${item.title} — ${item.credit}`; }

  function buildGrid(){ gridInner.innerHTML=''; slides.forEach((s,i)=>{ const card=document.createElement('div'); card.className='thumb'; card.innerHTML = `<div class="num">Diapo ${i+1}</div><div class="mini"><div class="mini-inner">${s.innerHTML}</div></div>`; card.onclick=()=>{ grid.classList.remove('active'); go(i,true); }; gridInner.appendChild(card); }); }
  buildGrid();

  function buildTimeline(){ timeline.innerHTML=''; for(let i=0;i<slides.length;i++){ const seg=document.createElement('div'); seg.className='seg'; seg.title=`Aller à la diapo ${i+1}`; seg.addEventListener('click', ()=> go(i,true)); timeline.appendChild(seg); } }
  buildTimeline();

  let mode='step'; let autoTimer=null; let autoDelay=3000; let idx=0; let fragIndex=0; const storageKey='deck:hub-vs-switch:v5.2';
  let global={ total:0, correct:0 }; const quizLog=[]; function refreshScore(){ scoreEl.textContent = global.total ? (global.correct+'/'+global.total) : '—'; }

  function bindQuiz(scope){ scope.querySelectorAll('.quiz').forEach(q=>{ if(q.dataset.bound==='1') return; q.dataset.bound='1'; const options=[...q.querySelectorAll('.q-option')]; const btnCheck=q.querySelector('.q-check'); const btnReset=q.querySelector('.q-reset'); const mode=q.dataset.mode||'single'; q.dataset.scored=q.dataset.scored||'0'; function toggleOption(opt){ if(mode==='single'){ options.forEach(o=>{ o.classList.remove('selected'); o.setAttribute('aria-selected','false'); }); opt.classList.add('selected'); opt.setAttribute('aria-selected','true'); } else { const sel=opt.classList.toggle('selected'); opt.setAttribute('aria-selected', sel?'true':'false'); } }
    options.forEach((opt)=>{ opt.addEventListener('click', ()=> toggleOption(opt)); opt.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleOption(opt); } }); });
    function numKey(e){ const n=parseInt(e.key,10); if(!isNaN(n) && n>=1 && n<=options.length && scope.classList.contains('active')){ toggleOption(options[n-1]); } }
    if(!q.dataset.numListener){ document.addEventListener('keydown', numKey); q.dataset.numListener='1'; }
    btnCheck?.addEventListener('click', ()=>{ const reveal=(safeStore.get(storageKey+':showCorr')||'1')==='1'; if(reveal){ options.forEach(o=>{ if(o.classList.contains('correct')||o.classList.contains('wrong')) o.classList.add('show'); }); }
      if(q.dataset.scored==='0'){ const selectedIdx=new Set(options.map((o,i)=> o.classList.contains('selected')? i : -1).filter(i=>i>=0)); const correctIdx=new Set(options.map((o,i)=> o.classList.contains('correct')? i : -1).filter(i=>i>=0)); let hit=false; if(mode==='single'){ hit = selectedIdx.size===1 && [...selectedIdx][0]===[...correctIdx][0]; } else { const eq=selectedIdx.size===correctIdx.size && [...selectedIdx].every(v=>correctIdx.has(v)); hit = selectedIdx.size>0 && eq; } global.total+=1; if(hit) global.correct+=1; q.dataset.scored='1'; refreshScore(); live.textContent = hit ? 'Bonne réponse !' : 'Réponse incorrecte.'; quizLog.push({slide: idx+1, result: hit?1:0, mode}); }
    });
    btnReset?.addEventListener('click', ()=>{ options.forEach(o=>{ o.classList.remove('selected','show'); o.setAttribute('aria-selected','false'); }); q.dataset.scored='0'; });
  });
  scope.querySelectorAll('.check input').forEach((cb,j)=>{ const key=storageKey+`:s${idx}:c${j}`; const saved=safeStore.get(key); if(saved!==null) cb.checked=(saved==='1'); cb.onchange=()=> safeStore.set(key, cb.checked?'1':'0'); }); }

  function updateStepDots(){ const current=slides[idx]; const fragments=[...current.querySelectorAll('.fragment')]; const show=(mode==='step'||mode==='auto') && fragments.length>0; stepIndicator.style.display= show ? 'flex' : 'none'; if(!show) return; let html=''; for(let i=0;i<=fragments.length;i++){ html += `<span class="dot ${i<=fragIndex?'active':''}"></span>`; } stepIndicator.innerHTML=html; }

  function update(){ slides.forEach((s,i)=> s.classList.toggle('active', i===idx)); const current=slides[idx]; const fragments=[...current.querySelectorAll('.fragment')]; if(mode==='full'){ fragIndex=fragments.length; } fragments.forEach((f,i)=> f.classList.toggle('visible', i<fragIndex)); bindQuiz(current); const percent=((idx+1)/slides.length); progress.style.width=(percent*100)+'%'; counter.textContent=`${idx+1} / ${slides.length}`; setBgForSlide(idx); [...timeline.children].forEach((seg,i)=>{ seg.classList.toggle('done', i<idx); seg.classList.toggle('active', i===idx); }); safeStore.set(storageKey+':slide', idx.toString()); setupLinksIfAny(); requestAnimationFrame(()=> positionAllLinks()); numberAllViewPages(); updateStepDots(); }
  function next(){ const current=slides[idx]; const fr=[...current.querySelectorAll('.fragment')]; if(mode==='step'||mode==='auto'){ if(fragIndex<fr.length){ fragIndex++; update(); return; } } if(idx<slides.length-1){ idx++; fragIndex=0; update(); } }
  function prev(){ if(fragIndex>0 && (mode==='step'||mode==='auto')){ fragIndex=0; update(); return; } if(idx>0){ idx--; fragIndex=0; update(); } }
  function go(n, reset){ idx=Math.max(0,Math.min(slides.length-1,n)); if(reset) fragIndex=0; update(); }

  function setTheme(name){
    document.body.classList.remove('theme-light');
    if(name==='light') document.body.classList.add('theme-light');
    safeStore.set(storageKey+':theme', name);
    document.getElementById('themeBtn').textContent = '🎨 ' + (name==='light' ? 'Clair' : 'Sombre');
  }
  function cycleTheme(){ const cur=safeStore.get(storageKey+':theme') || 'dark'; setTheme(cur==='dark' ? 'light' : 'dark'); }

  function setMode(m){ mode=m; const label=(m==='step'?'Pas à pas':(m==='full'?'Complet':'Auto')); const ml2=document.getElementById('modeLabel2'); if(ml2) ml2.textContent=label; const modeDisplay=document.getElementById('modeDisplay'); if(modeDisplay) modeDisplay.textContent=label; if(mode==='auto') startAuto(); else stopAuto(); safeStore.set(storageKey+':mode', m); update(); }
  function cycleMode(){ const modes=['step','full','auto']; setMode(modes[(modes.indexOf(mode)+1)%3]); }
  function startAuto(){ stopAuto(); autoTimer=setInterval(()=>{ const current=slides[idx]; const fr=[...current.querySelectorAll('.fragment')]; if(fragIndex<fr.length){ fragIndex++; update(); return; } if(idx<slides.length-1){ idx++; fragIndex=0; update(); return; } stopAuto(); }, autoDelay); }
  function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }

  document.getElementById('settingsBtn').addEventListener('click', ()=>{ document.getElementById('panel').classList.toggle('active'); });
  const speedRange=document.getElementById('speed'); const speedValue=document.getElementById('speedVal');
  speedRange.addEventListener('input', ()=>{ autoDelay=Number(speedRange.value)*1000; speedValue.textContent=speedRange.value+'s'; safeStore.set(storageKey+':speed', speedRange.value); if(mode==='auto'){ startAuto(); } });
  const imgToggle=document.getElementById('imgToggle'); imgToggle.addEventListener('change', ()=>{ document.documentElement.style.setProperty('--img-opacity', imgToggle.checked? '.12' : '0'); safeStore.set(storageKey+':img', imgToggle.checked?'1':'0'); });
  const showCorr=document.getElementById('showCorr'); showCorr.addEventListener('change', ()=>{ safeStore.set(storageKey+':showCorr', showCorr.checked?'1':'0'); });

  const showScore=document.getElementById('showScore'); const showStudent=document.getElementById('showStudent'); const studentMode=document.getElementById('studentMode');
  function applyUiToggles(){ scoreBadge.style.display= showScore.checked? '' : 'none'; studentField.style.display= showStudent.checked? '' : 'none'; ['pdfBtn','exportBtn','resetBtn'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display = studentMode.checked? 'none' : ''; }); safeStore.set(storageKey+':ui', JSON.stringify({score:showScore.checked, student:showStudent.checked, smode:studentMode.checked})); }
  showScore.addEventListener('change', applyUiToggles); showStudent.addEventListener('change', applyUiToggles); studentMode.addEventListener('change', applyUiToggles);

  const studentName=document.getElementById('studentName'); const studentPanel=document.getElementById('studentPanel');
  function syncStudent(val){ if(studentName) studentName.value=val||''; if(studentPanel) studentPanel.value=val||''; safeStore.set(storageKey+':student', val||''); }
  studentName?.addEventListener('input', ()=> syncStudent(studentName.value)); studentPanel?.addEventListener('input', ()=> syncStudent(studentPanel.value));

  const allBtn=document.getElementById('allBtn'); const allView=document.getElementById('printRoot');
  allBtn.addEventListener('click', ()=>{ const on=document.body.classList.toggle('allinone'); allBtn.setAttribute('aria-pressed', on?'true':'false'); if(on){ allView.innerHTML=''; slides.forEach((s,i)=>{ const clone=s.cloneNode(true); clone.querySelectorAll('.fragment').forEach(f=> f.classList.add('visible')); clone.classList.add('slide'); clone.style.background='var(--panel)'; clone.style.border='1px solid var(--border)'; clone.style.borderRadius='12px'; clone.style.margin='0 0 18px'; clone.style.padding='28px 56px'; const pn=document.createElement('div'); pn.className='page-num'; pn.textContent=`Diapo ${i+1}`; clone.appendChild(pn); allView.appendChild(clone); }); } });
  function numberAllViewPages(){ if(!document.body.classList.contains('allinone')) return; [...document.querySelectorAll('#printRoot .page-num')].forEach((n,i)=> n.textContent=`Diapo ${i+1}`); }

  function preparePrint(){ const root=document.getElementById('printRoot'); if(!root) return; root.innerHTML=''; slides.forEach((s,i)=>{ const clone=s.cloneNode(true); clone.querySelectorAll('.fragment').forEach(f=> f.classList.add('visible')); clone.classList.add('slide'); clone.style.background='var(--panel)'; clone.style.border='1px solid var(--border)'; clone.style.borderRadius='12px'; clone.style.margin='0 0 18px'; clone.style.padding='28px 56px'; const pn=document.createElement('div'); pn.className='page-num'; pn.textContent=`Diapo ${i+1}`; clone.appendChild(pn); root.appendChild(clone); }); }
  window.addEventListener('beforeprint', preparePrint);
  window.addEventListener('afterprint', ()=>{ const root=document.getElementById('printRoot'); if(root) root.innerHTML=''; });

  const timer=document.getElementById('timer'); const timerDisplay=document.getElementById('timerDisplay'); const minInput=document.getElementById('minInput'); const secInput=document.getElementById('secInput');
  let countdown=0, timerHandle=null; function fmt(n){ return String(n).padStart(2,'0'); }
  function renderTimer(){ const m=Math.floor(countdown/60), s=countdown%60; const text=`${fmt(m)}:${fmt(s)}`; timerDisplay.textContent=text; miniTimerChip.textContent=`⏱ ${text}`; }
  function beep(){ try{ const AC=window.AudioContext||window.webkitAudioContext; const ac=new AC(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0.0001, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.3, ac.currentTime+0.02); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.3); o.stop(ac.currentTime+0.35); ac.close(); }, 350); }catch(e){} navigator.vibrate?.(150); }
  function startTimer(){ if(timerHandle) return; countdown=(parseInt(minInput.value)||0)*60 + (parseInt(secInput.value)||0); renderTimer(); if(countdown<=0) return; miniTimerChip.hidden=false; timerHandle=setInterval(()=>{ if(countdown>0){ countdown--; renderTimer(); } else { stopTimer(); beep(); miniTimerChip.hidden=true; } }, 1000); }
  function stopTimer(){ if(timerHandle){ clearInterval(timerHandle); timerHandle=null; } }
  function resetTimer(){ stopTimer(); countdown=0; renderTimer(); miniTimerChip.hidden=true; }
  document.getElementById('timerBtn').addEventListener('click', ()=> timer.classList.toggle('active'));
  document.getElementById('startTimer').addEventListener('click', startTimer);
  document.getElementById('pauseTimer').addEventListener('click', ()=>{ stopTimer(); });
  document.getElementById('resetTimer').addEventListener('click', resetTimer);
  document.querySelectorAll('[data-preset]').forEach(b=> b.addEventListener('click', ()=>{ const s=parseInt(b.dataset.preset,10)||0; minInput.value=Math.floor(s/60); secInput.value=s%60; }));
  miniTimerChip.addEventListener('click', ()=> timer.classList.toggle('active'));

  const drawWrap=document.getElementById('drawWrap'); const drawCanvas=document.getElementById('drawCanvas'); const drawOverlay=document.getElementById('drawOverlay');
  let penOn=false, drawing=false, ctx=null, last=null;
  function initCanvas(){ const r=drawWrap.getBoundingClientRect(); drawCanvas.width=r.width; drawCanvas.height=r.height; ctx=drawCanvas.getContext('2d'); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=document.getElementById('penColor').value; ctx.lineWidth=parseInt(document.getElementById('penSize').value,10)||3; }
  document.getElementById('drawBtn').addEventListener('click', ()=>{ penOn=!penOn; drawWrap.classList.toggle('active', penOn); drawOverlay?.classList.toggle('active', penOn); if(penOn) initCanvas(); });
  document.getElementById('penClear')?.addEventListener('click', ()=>{ if(ctx) ctx.clearRect(0,0, drawCanvas.width, drawCanvas.height); });
  document.getElementById('penSize')?.addEventListener('input', (e)=>{ if(ctx) ctx.lineWidth=parseInt(e.target.value,10)||3; });
  document.getElementById('penColor')?.addEventListener('input', (e)=>{ if(ctx) ctx.strokeStyle=e.target.value; });
  document.getElementById('penSave')?.addEventListener('click', ()=>{ const url=drawCanvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`annotation_s${idx+1}.png`; a.click(); });
  function getPos(e){ const r=drawCanvas.getBoundingClientRect(); const px=(e.touches? e.touches[0].clientX : e.clientX) - r.left; const py=(e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x:px, y:py}; }
  drawCanvas.addEventListener('mousedown', (e)=>{ if(!penOn) return; drawing=true; last=getPos(e); e.preventDefault(); });
  drawCanvas.addEventListener('mousemove', (e)=>{ if(!drawing||!penOn) return; const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault(); });
  window.addEventListener('mouseup', ()=> drawing=false);
  drawCanvas.addEventListener('touchstart', (e)=>{ if(penOn){ drawing=true; last=getPos(e); e.preventDefault(); }}, {passive:false});
  drawCanvas.addEventListener('touchmove', (e)=>{ if(drawing&&penOn){ const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault(); }}, {passive:false});
  drawCanvas.addEventListener('touchend', ()=> drawing=false);

  document.getElementById('exportBtn').addEventListener('click', ()=>{ const title='Hub vs Switch'; const now=new Date(); const iso=now.toISOString(); const percent= global.total ? Math.round((global.correct/global.total)*100) : 0; const student=safeStore.get(storageKey+':student')||''; let csv=`Date,Titre,Eleve,Total,Correct,Pourcentage\n${iso},${title},${student},${global.total},${global.correct},${percent}%`; const json=JSON.stringify({date:iso,title,student,total:global.total,correct:global.correct,percent,log:quizLog}, null, 2); [{name:`score_${iso.slice(0,10)}.csv`,data:csv,type:'text/csv'},{name:`score_${iso.slice(0,10)}.json`,data:json,type:'application/json'}].forEach(f=>{ const blob=new Blob([f.data], {type:f.type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=f.name; a.click(); }); });

  document.getElementById('resetBtn').addEventListener('click', ()=>{ ['slide','theme','mode','speed','img','showCorr','student','ui'].forEach(k=> safeStore.del(storageKey+':'+k)); location.reload(); });

  document.getElementById('prevBtn').onclick=prev; document.getElementById('nextBtn').onclick=next; document.getElementById('gridBtn').onclick=()=> grid.classList.toggle('active');
  async function toggleFullscreen(){ try{ if(!document.fullscreenElement && !document.webkitFullscreenElement){ const el=deck; if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen(); } else { if(document.exitFullscreen) await document.exitFullscreen(); else if(document.webkitExitFullscreen) document.webkitExitFullscreen(); } }catch(e){} }
  document.getElementById('fullscreenBtn').onclick=toggleFullscreen;
  document.getElementById('pdfBtn').onclick=()=>{ preparePrint(); window.print(); };
  document.getElementById('themeBtn').addEventListener('click', cycleTheme);
  document.getElementById('modeBtn').addEventListener('click', cycleMode);

  document.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight' || e.key===' '){ next(); e.preventDefault(); }
    if(e.key==='ArrowLeft'){ prev(); e.preventDefault(); }
    if(e.key.toLowerCase()==='g'){ grid.classList.toggle('active'); }
    if(e.key.toLowerCase()==='f'){ toggleFullscreen(); }
    if(e.key.toLowerCase()==='p'){ window.print(); }
    if(e.key.toLowerCase()==='t'){ document.getElementById('timer').classList.toggle('active'); }
    if(e.key.toLowerCase()==='d'){ document.getElementById('drawBtn').click(); }
    if(e.key==='?'){ help.classList.toggle('active'); }
    if(e.key==='Escape'){ document.getElementById('panel').classList.remove('active'); help.classList.remove('active'); document.getElementById('timer').classList.remove('active'); closeLightbox(); }
  });

  let touchX=null; viewport.addEventListener('touchstart', (e)=>{ touchX=e.changedTouches[0].clientX; }, {passive:true});
  viewport.addEventListener('touchend', (e)=>{ if(touchX===null) return; const dx=e.changedTouches[0].clientX - touchX; if(Math.abs(dx)>60){ if(dx<0) next(); else prev(); } touchX=null; }, {passive:true});

  function scale(){ const isFs=(document.fullscreenElement===deck)||(document.webkitFullscreenElement===deck); const padW=isFs?0:48; const padH=isFs?0:140; const w=window.innerWidth - padW; const h=window.innerHeight - padH; const sx=w/1280; const sy=h/720; const s=isFs? Math.min(sx,sy) : Math.min(1.0, Math.min(sx,sy)); deck.style.transform=`scale(${s})`; debouncedPos(); }
  window.addEventListener('resize', scale);
  document.addEventListener('fullscreenchange', scale);
  document.addEventListener('webkitfullscreenchange', scale);
  viewport.addEventListener('scroll', debouncedPos, {passive:true}); /* v5.2: recalcul sur scroll */
  const ro = (window.ResizeObserver)? new ResizeObserver(()=> debouncedPos()) : null; if(ro){ ro.observe(viewport); }
  scale();

  const savedIdx=safeStore.get(storageKey+':slide'); if(savedIdx) idx=Math.min(slides.length-1, Math.max(0, parseInt(savedIdx,10)));
  const savedTheme=safeStore.get(storageKey+':theme'); if(savedTheme) setTheme(savedTheme); else setTheme('dark');
  const savedMode=safeStore.get(storageKey+':mode'); if(savedMode) setMode(savedMode); else setMode('step');
  const savedSpeed=safeStore.get(storageKey+':speed'); if(savedSpeed){ speedRange.value=savedSpeed; speedRange.dispatchEvent(new Event('input')); }
  const savedImg=safeStore.get(storageKey+':img'); if(savedImg){ document.getElementById('imgToggle').checked = savedImg==='1'; document.getElementById('imgToggle').dispatchEvent(new Event('change')); }
  const savedCorr=safeStore.get(storageKey+':showCorr'); if(savedCorr){ document.getElementById('showCorr').checked = savedCorr==='1'; }
  const savedStudent=safeStore.get(storageKey+':student'); if(savedStudent){ document.getElementById('studentName').value=savedStudent; document.getElementById('studentPanel').value=savedStudent; }
  const savedUi=safeStore.get(storageKey+':ui'); if(savedUi){ try{ const u=JSON.parse(savedUi); document.getElementById('showScore').checked=!!u.score; document.getElementById('showStudent').checked=!!u.student; document.getElementById('studentMode').checked=!!u.smode; }catch{} }
  applyUiToggles();

  update(); refreshScore();
})();
</script>

<script>
/* ===== Simulateur : MAC learning + démos ===== */
const MAC = {A:'02:00:00:00:00:0A', B:'02:00:00:00:00:0B', C:'02:00:00:00:00:0C', D:'02:00:00:00:00:0D'};
const PORT = {A:'1',B:'2',C:'3',D:'4'}; let swTable = {};
function renderMac(highlight){ const body=document.getElementById('macBody'); if(!body) return; body.innerHTML=''; Object.keys(swTable).sort().forEach(mac=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${mac}</td><td>${swTable[mac]}</td>`; if(highlight && highlight===mac){ tr.classList.add('new'); setTimeout(()=> tr.classList.remove('new'), 1400); } body.appendChild(tr); }); }
function resetSim(){ swTable = {}; renderMac(); document.querySelectorAll('.pulse').forEach(p=>p.remove()); const col=document.getElementById('colHub'); col?.classList.remove('show'); setHubLoad(0); ['hA','hB','hC','hD','sA','sB','sC','sD'].forEach(id=> document.getElementById(id)?.classList.remove('active')); document.querySelector('#netSw .device')?.classList.remove('active'); positionAllLinks(); }
function pulseAt(container, x, y, color){ const p=document.createElement('div'); p.className='pulse'; if(color){ p.style.background=color; p.style.boxShadow=`0 0 20px ${color}`; } p.style.left=x+'px'; p.style.top=y+'px'; p.style.zIndex='10'; container.appendChild(p); setTimeout(()=> p.remove(), 900); }
function centerOf(el){ const r=el.getBoundingClientRect(); const pr=el.parentElement.getBoundingClientRect(); return {x:r.left+r.width/2-pr.left, y:r.top+r.height/2-pr.top}; }
function moveDot(container, from, to, duration=520, color){ const dot=document.createElement('div'); dot.style.position='absolute'; dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%'; dot.style.background = color || 'var(--accent)'; dot.style.boxShadow = `0 0 14px ${color||'var(--accent)'}`; dot.style.zIndex='10'; container.appendChild(dot); const t0=performance.now(); function tick(t){ const a=(t - t0) / duration; const k=Math.min(1, a); const x=from.x + (to.x - from.x)*k; const y=from.y + (to.y - from.y)*k; dot.style.left=x+'px'; dot.style.top=y+'px'; if(k<1) requestAnimationFrame(tick); else setTimeout(()=> dot.remove(), 120); } requestAnimationFrame(tick); }
function blink(el){ el?.classList.add('active'); setTimeout(()=> el?.classList.remove('active'), 600); }

function setHubLoad(pct){ const fill=document.getElementById('hubFill'); const pctEl=document.getElementById('hubPct'); if(!fill||!pctEl) return; fill.style.width=Math.max(0, Math.min(100, pct)) + '%'; pctEl.textContent=Math.round(Math.max(0, Math.min(100, pct))) + '%'; }
function simHub(){ const hub=document.getElementById('netHub'); if(!hub) return; const A=document.getElementById('hA'); const DVC=hub.querySelector('.device'); const pts=['hB','hC','hD'].map(id=> document.getElementById(id)); const a=centerOf(A), d=centerOf(DVC); blink(A); blink(DVC); moveDot(hub, a, d, 460, 'var(--accent)'); setHubLoad(60); setTimeout(()=>{ pts.forEach((el,j)=>{ const p=centerOf(el); moveDot(hub, d, p, 360+ j*40, '#f59e0b'); blink(el); }); setTimeout(()=> setHubLoad(20), 900); }, 200); }
function simHubCD(){ const hub=document.getElementById('netHub'); if(!hub) return; const C=document.getElementById('hC'); const DVC=hub.querySelector('.device'); const pts=['hA','hB','hD'].map(id=> document.getElementById(id)); const c=centerOf(C), d=centerOf(DVC); blink(C); blink(DVC); moveDot(hub, c, d, 460, 'var(--accent)'); setHubLoad(55); setTimeout(()=>{ pts.forEach((el,j)=>{ const p=centerOf(el); moveDot(hub, d, p, 360+ j*40, '#f59e0b'); blink(el); }); setTimeout(()=> setHubLoad(20), 900); }, 200); }
function simHubCollision(){ const hub=document.getElementById('netHub'); if(!hub) return; const col=document.getElementById('colHub'); setHubLoad(95); col?.classList.add('show'); const A=document.getElementById('hA'), C=document.getElementById('hC'); const DVC=hub.querySelector('.device'); const a=centerOf(A), c=centerOf(C), d=centerOf(DVC); blink(A); blink(C); blink(DVC); moveDot(hub, a, d, 280, '#ef4444'); moveDot(hub, c, d, 280, '#ef4444'); setTimeout(()=>{ col?.classList.remove('show'); setHubLoad(35); }, 700); }

function renderAfterLearn(mac){ renderMac(mac); blink(document.querySelector('#netSw .device')); }
function simSwitch(){ const sw=document.getElementById('netSw'); if(!sw) return; const A=document.getElementById('sA'); const B=document.getElementById('sB'); const DVC=sw.querySelector('.device'); const a=centerOf(A), b=centerOf(B), d=centerOf(DVC); blink(A); swTable[MAC.A]=PORT.A; renderAfterLearn(MAC.A); moveDot(sw, a, d, 320, 'var(--accent)'); const knowB=!!swTable[MAC.B]; setTimeout(()=>{ if(knowB){ moveDot(sw, d, b, 360, '#10b981'); blink(B); } else { ['sB','sC','sD'].forEach((id,j)=>{ const t=centerOf(document.getElementById(id)); setTimeout(()=>{ moveDot(sw, d, t, 300, '#f59e0b'); blink(document.getElementById(id)); if(id==='sB'){ swTable[MAC.B]=PORT.B; renderAfterLearn(MAC.B); } }, j*80); }); } }, 260); }
function simSwitchCA(){ const sw=document.getElementById('netSw'); if(!sw) return; const C=document.getElementById('sC'); const A=document.getElementById('sA'); const DVC=sw.querySelector('.device'); swTable[MAC.C]=PORT.C; renderAfterLearn(MAC.C); const c=centerOf(C), a=centerOf(A), d=centerOf(DVC); blink(C); moveDot(sw, c, d, 320, 'var(--accent)'); setTimeout(()=>{ if(swTable[MAC.A]){ moveDot(sw, d, a, 360, '#10b981'); blink(A); } else { ['sA','sB','sD'].forEach((id,j)=>{ const t=centerOf(document.getElementById(id)); setTimeout(()=>{ moveDot(sw, d, t, 300, '#f59e0b'); blink(document.getElementById(id)); if(id==='sA'){ swTable[MAC.A]=PORT.A; renderAfterLearn(MAC.A); } }, j*80); }); } }, 260); }
function simSwitchBroadcast(){ const sw=document.getElementById('netSw'); if(!sw) return; const A=document.getElementById('sA'); const DVC=sw.querySelector('.device'); swTable[MAC.A]=PORT.A; renderAfterLearn(MAC.A); const a=centerOf(A), d=centerOf(DVC); blink(A); moveDot(sw, a, d, 320, 'var(--accent)'); setTimeout(()=>{ ['sB','sC','sD'].forEach((id,j)=>{ const t=centerOf(document.getElementById(id)); setTimeout(()=>{ moveDot(sw, d, t, 300, '#f59e0b'); blink(document.getElementById(id)); }, j*80); }); }, 240); }

(function tests(){ try{ console.assert(typeof simHub==='function' && typeof simSwitch==='function', 'Simulateur exposé'); }catch(e){} })();
</script>

  <div class="spotlight" id="spotlight" aria-hidden="true"></div>
</body>
<script>
// === v6 — Améliorations UX/Animations (sans toucher au cœur de ton modèle) ===
(function(){
  const SK = 'deck:hub-vs-switch:v5.2'; // même clé de stockage que le modèle d'origine

  // 3.1 Projecteur (L)
  const spotlight = document.getElementById('spotlight');
  let spotOn = false;
  function toggleSpot(){ spotOn = !spotOn; spotlight.classList.toggle('on', spotOn); }
  function moveSpot(e){
    if(!spotOn) return;
    const x = (e.touches ? e.touches[0].clientX : e.clientX) + 'px';
    const y = (e.touches ? e.touches[0].clientY : e.clientY) + 'px';
    spotlight.style.setProperty('--x', x);
    spotlight.style.setProperty('--y', y);
  }
  document.addEventListener('keydown', (e)=>{
    if((e.key||'').toLowerCase() === 'l'){ toggleSpot(); }
  });
  document.addEventListener('mousemove', moveSpot, {passive:true});
  document.addEventListener('touchmove', moveSpot, {passive:true});

  // 3.2 Fragments — attribution d'animations + décalage automatique
  function assignFragAnimations(scope){
    if(!scope) return;
    const mode = (safeStore.get(SK+':fragMode') || 'mix'); // 'fade' | 'rise' | 'right' | 'scale' | 'mix'
    const frags = Array.from(scope.querySelectorAll('.fragment'));
    frags.forEach((f, i)=>{
      if(!f.dataset.anim){
        let a = 'fade';
        if(mode === 'mix'){ a = ['fade','rise','right','scale'][i % 4]; }
        else { a = mode; }
        f.dataset.anim = a;
        f.style.setProperty('--d', Math.min(i*60, 600) + 'ms'); // petit décalage progressif
      }
    });
  }

  // Observer pour (re)attribuer dès que la diapo active ou les fragments changent d'état
  const viewport = document.getElementById('viewport');
  const mo = new MutationObserver(()=>{
    const active = document.querySelector('.slide.active');
    assignFragAnimations(active);
  });
  mo.observe(viewport, {subtree:true, attributes:true, attributeFilter:['class']});
  // première passe
  assignFragAnimations(document.querySelector('.slide.active'));

  // 3.3 Transitions de diapos — via data-trans sur <body> (fade/slide/zoom)
  const curTrans = safeStore.get(SK+':trans') || 'fade';
  document.body.dataset.trans = curTrans;

  // 3.4 Ajout de contrôles dans "Réglages" (sans modifier l'HTML d'origine)
  const panel = document.getElementById('panel');
  if(panel){
    const creditRow = panel.querySelector('.row small#img-credit')?.parentElement || panel.lastElementChild;

    function mkRow(labelTxt, inputEl){
      const row = document.createElement('div');
      row.className = 'row';
      const span = document.createElement('span');
      span.textContent = labelTxt;
      row.appendChild(span);
      if(inputEl) row.appendChild(inputEl);
      return row;
    }

    // Select Transition
    const transSel = document.createElement('select');
    transSel.className = 'input';
    ['fade','slide','zoom'].forEach(v=>{
      const o=document.createElement('option');
      o.value=v; o.textContent = v;
      if(v===curTrans) o.selected = true;
      transSel.appendChild(o);
    });
    transSel.addEventListener('change', ()=>{
      document.body.dataset.trans = transSel.value;
      safeStore.set(SK+':trans', transSel.value);
      // force relance de l'anim sur diapo courante
      const cur = document.querySelector('.slide.active');
      if(cur){
        cur.classList.remove('active');
        requestAnimationFrame(()=>{ cur.classList.add('active'); });
      }
    });

    // Select Fragments
    const fragMode = safeStore.get(SK+':fragMode') || 'mix';
    const fragSel = document.createElement('select');
    fragSel.className = 'input';
    ['mix','fade','rise','right','scale'].forEach(v=>{
      const o=document.createElement('option');
      o.value=v; o.textContent = v;
      if(v===fragMode) o.selected = true;
      fragSel.appendChild(o);
    });
    fragSel.addEventListener('change', ()=>{
      safeStore.set(SK+':fragMode', fragSel.value);
      // on retire les data-anim pour réattribuer proprement
      document.querySelectorAll('.slide .fragment').forEach(f=>{
        f.removeAttribute('data-anim');
        f.style.removeProperty('--d');
      });
      assignFragAnimations(document.querySelector('.slide.active'));
    });

    panel.insertBefore(mkRow('Transition diapo :', transSel), creditRow);
    panel.insertBefore(mkRow('Animation fragments :', fragSel), creditRow);
  }

  // 3.5 Barre d'outils — atténuation quand idle (desktop)
  const toolbar = document.querySelector('.toolbar');
  let idleTimer = null;
  function bump(){
    if(!toolbar) return;
    toolbar.classList.remove('idle');
    clearTimeout(idleTimer);
    idleTimer = setTimeout(()=> toolbar.classList.add('idle'), 2600);
  }
  ['mousemove','keydown','touchstart'].forEach(ev=> document.addEventListener(ev, bump, {passive:true}));
  bump();
})();
</script>

</body></body>
</html>
